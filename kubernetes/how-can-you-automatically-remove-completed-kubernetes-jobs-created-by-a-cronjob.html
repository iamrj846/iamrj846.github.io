
    
            <!DOCTYPE html>
        <html lang="en">

        <head>
            <!-- Google tag (gtag.js) -->
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-TFCQEJR7TD"></script>
            <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-TFCQEJR7TD');
            </script>
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            
            <meta property="og:title" content="How can you automatically remove completed Kubernetes Jobs created by a CronJob?" />
            <meta property="og:description" content="Discover how to automate the removal of completed Kubernetes Jobs from CronJobs to optimize your cluster management and resources." />
            <meta property="og:url" content="https://www.bestonlinetutorial.com/kubernetes/how-can-you-automatically-remove-completed-kubernetes-jobs-created-by-a-cronjob.html" />
            <link rel="canonical" href="https://www.bestonlinetutorial.com/kubernetes/how-can-you-automatically-remove-completed-kubernetes-jobs-created-by-a-cronjob.html">
            <meta property="og:type" content="article" />
            <meta property="og:site_name" content=“BestOnlineTutorial” />
            <meta name="twitter:title" content="How can you automatically remove completed Kubernetes Jobs created by a CronJob?" />
            <meta name="twitter:description" content="Discover how to automate the removal of completed Kubernetes Jobs from CronJobs to optimize your cluster management and resources." />
            <meta name="pinterest-rich-pin" content="true" />

            <script type="application/ld+json">
                {
                "@context": "https://schema.org",
                "@type": "WebSite",
                "name": "BestOnlineTutorial",
                "url": "https://www.bestonlinetutorial.com/"
                }
            </script>
            <!-- Common CSS & Icons -->
            <link rel="icon" href="/favicon.ico" type="image/x-icon">
            <link rel="stylesheet" href="/assets/plugins/highlight/styles/monokai-sublime.css">
            <link id="theme-style" rel="stylesheet" href="/assets/css/theme-8.css">
            <link rel="stylesheet" href="/assets/css/post.css">
            <title>How can you automatically remove completed Kubernetes Jobs created by a CronJob?</title>
            <meta name="description" content="Discover how to automate the removal of completed Kubernetes Jobs from CronJobs to optimize your cluster management and resources.">
            <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	        <script src="/assets/js/blog.js"></script>
        </head>

        <body>

            <div id="header-placeholder"></div>

            <div class="main-wrapper">

                <article class="blog-post px-3 py-5 p-md-5">
                    <div class="container single-col-max-width">
                        <header class="blog-post-header">
                            <h1 class="title mb-2">How can you automatically remove completed Kubernetes Jobs created by a CronJob?</h1>
                        </header>

                        <div class="blog-post-body">
                            <p>To remove completed Kubernetes Jobs made by a CronJob automatically,
we can use the <strong>TTL (Time to Live)</strong> feature. When we set
a TTL, Kubernetes will delete jobs that are finished, whether they
succeeded or failed, after a certain time. This helps keep our cluster
clean and runs better. It stops old jobs from piling up and making our
environment messy.</p>
<p>In this article, we will look at different ways to manage and remove
completed Kubernetes Jobs made by a CronJob. We will talk about the
retention policy for Kubernetes jobs. We will learn how to use TTL. We
will also discuss how to set up a Kubernetes controller for cleanup.
Plus, we will see how to use Kubernetes garbage collection and how to
automate cleanup with custom scripts. Each way gives us a different
method to manage job life and resource use.</p>
<ul>
<li>How to Automatically Remove Completed Kubernetes Jobs Created by a
CronJob</li>
<li>Understanding the Retention Policy for Kubernetes Jobs</li>
<li>Utilizing TTL for Finished Jobs in Kubernetes</li>
<li>Implementing a Kubernetes Controller for Job Cleanup</li>
<li>Leveraging Kubernetes Garbage Collection for Job Management</li>
<li>Automating Cleanup with Custom Scripts for Kubernetes Jobs</li>
<li>Frequently Asked Questions</li>
</ul>
<h2
id="understanding-the-retention-policy-for-kubernetes-jobs">Understanding
the Retention Policy for Kubernetes Jobs</h2>
<p>Kubernetes Jobs have a retention policy. This policy tells us how
long finished jobs should stay before they get deleted. By default,
completed jobs stay forever. This can make our cluster messy if we do
not manage it well. If we understand and set retention policies, we can
manage our resources better. This helps us avoid wasting resources.</p>
<h3 id="key-properties-of-job-retention">Key Properties of Job
Retention</h3>
<ol type="1">
<li><p><strong>TTL (Time to Live)</strong>: Kubernetes lets us set a TTL
for jobs. We use the <code>ttlSecondsAfterFinished</code> field in the
job specification. This tells us how long the finished job should stay
before it is deleted automatically.</p>
<p>Here is an example of how to set a TTL for a job:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> batch/v1</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Job</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> example-job</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ttlSecondsAfterFinished</span><span class="kw">:</span><span class="at"> </span><span class="dv">3600</span><span class="co">  # Job will be deleted 1 hour after completion</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> example</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> example-image</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> Never</span></span></code></pre></div></li>
<li><p><strong>Completed Jobs</strong>: By default, completed jobs stay
in the cluster. This may not be good for places where jobs run often. If
we set a TTL, jobs will not stay longer than they need.</p></li>
<li><p><strong>Failed Jobs</strong>: We can also choose to keep or
delete failed jobs based on rules we set. Managing these can help us
track failures better without making the system messy.</p></li>
<li><p><strong>Job Cleanup</strong>: The retention policy is important
for keeping a clean environment. This is especially true in CI/CD
pipelines and batch processing tasks. When we use it with other cleanup
methods, it helps us use resources wisely.</p></li>
</ol>
<p>When we set the retention policy well, our Kubernetes Jobs will be
cleaned up automatically after they finish. This way, we can use
resources better in our Kubernetes cluster. For more tips on managing
Kubernetes Jobs, check out this <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-run-batch-jobs-in-kubernetes-with-jobs-and-cronjobs.html">article
on running batch jobs in Kubernetes</a>.</p>
<h2 id="using-ttl-for-finished-jobs-in-kubernetes">Using TTL for
Finished Jobs in Kubernetes</h2>
<p>Kubernetes has a feature called Time To Live (TTL) for finished Jobs.
This feature helps us clean up completed jobs after a set time. It is
very helpful for managing Jobs made by CronJobs. It keeps our cluster
tidy by removing old jobs automatically.</p>
<h3 id="setting-up-ttl-for-jobs">Setting Up TTL for Jobs</h3>
<p>To use TTL in Kubernetes, we can add the
<code>ttlSecondsAfterFinished</code> field in the Job spec. This field
tells how many seconds after the Job is done before it can be
deleted.</p>
<p>Here is an example of a Job YAML configuration with TTL:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> batch/v1</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Job</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> example-job</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ttlSecondsAfterFinished</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span><span class="co">  # Job will be deleted 100 seconds after it finishes</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> example</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> my-job-image</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> Never</span></span></code></pre></div>
<h3 id="ttl-in-cronjobs">TTL in CronJobs</h3>
<p>When we use CronJobs, we can also set a TTL for the Jobs they create.
This means that when a Job is finished, it can be cleaned up based on
the TTL we set. Here is how to do it in a CronJob:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> batch/v1</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> CronJob</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> example-cronjob</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;*/5 * * * *&quot;</span><span class="co">  # Run every 5 minutes</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">jobTemplate</span><span class="kw">:</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ttlSecondsAfterFinished</span><span class="kw">:</span><span class="at"> </span><span class="dv">120</span><span class="co">  # Jobs will be deleted 120 seconds after they finish</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> example</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">image</span><span class="kw">:</span><span class="at"> my-job-image</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> Never</span></span></code></pre></div>
<h3 id="important-considerations">Important Considerations</h3>
<ul>
<li><strong>Cluster Version</strong>: We need to make sure that our
Kubernetes cluster version supports the TTL feature. It started in
Kubernetes 1.21.</li>
<li><strong>Deletion Timing</strong>: The Job will not be deleted right
after it finishes. It will wait for the time we set before it is marked
for deletion.</li>
<li><strong>Resource Management</strong>: Using TTL helps us manage
resources better. It automatically cleans up resources that we do not
need anymore.</li>
</ul>
<p>By using TTL for finished Jobs, we can make managing Jobs from
CronJobs easier in our Kubernetes setup. This helps keep the cluster
clean and organized. For more details, we can check the official
Kubernetes documentation on <a
href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/">jobs</a>.</p>
<h2
id="implementing-a-kubernetes-controller-for-job-cleanup">Implementing a
Kubernetes Controller for Job Cleanup</h2>
<p>We can automatically remove completed Kubernetes Jobs made by a
CronJob. To do this, we will create a custom Kubernetes controller. This
controller will watch for finished Jobs and delete them based on some
rules. Below are the steps to make this controller using the client-go
library in Go.</p>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>We need Go installed on our machine.</li>
<li>We should have access to a Kubernetes cluster.</li>
<li>We must include the client-go library in our project.</li>
</ul>
<h3 id="code-example">Code Example</h3>
<ol type="1">
<li><strong>Create a new Go file for your controller</strong>:</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;context&quot;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;fmt&quot;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os&quot;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;time&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;k8s.io/apimachinery/pkg/util/errors&quot;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;k8s.io/client-go/kubernetes&quot;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;k8s.io/client-go/tools/clientcmd&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;k8s.io/client-go/util/homedir&quot;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    kubeconfig <span class="op">:=</span> os<span class="op">.</span>Getenv<span class="op">(</span><span class="st">&quot;KUBECONFIG&quot;</span><span class="op">)</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> kubeconfig <span class="op">==</span> <span class="st">&quot;&quot;</span> <span class="op">{</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        kubeconfig <span class="op">=</span> filepath<span class="op">.</span>Join<span class="op">(</span>homedir<span class="op">.</span>HomeDir<span class="op">(),</span> <span class="st">&quot;.kube&quot;</span><span class="op">,</span> <span class="st">&quot;config&quot;</span><span class="op">)</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    config<span class="op">,</span> err <span class="op">:=</span> clientcmd<span class="op">.</span>BuildConfigFromFlags<span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">,</span> kubeconfig<span class="op">)</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">panic</span><span class="op">(</span>err<span class="op">.</span>Error<span class="op">())</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    clientset<span class="op">,</span> err <span class="op">:=</span> kubernetes<span class="op">.</span>NewForConfig<span class="op">(</span>config<span class="op">)</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">panic</span><span class="op">(</span>err<span class="op">.</span>Error<span class="op">())</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    jobCleanup<span class="op">(</span>clientset<span class="op">)</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> jobCleanup<span class="op">(</span>clientset <span class="op">*</span>kubernetes<span class="op">.</span>Clientset<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    ticker <span class="op">:=</span> time<span class="op">.</span>NewTicker<span class="op">(</span><span class="dv">30</span> <span class="op">*</span> time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">defer</span> ticker<span class="op">.</span>Stop<span class="op">()</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">&lt;-</span>ticker<span class="op">.</span>C<span class="op">:</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>            jobs<span class="op">,</span> err <span class="op">:=</span> clientset<span class="op">.</span>BatchV1<span class="op">().</span>Jobs<span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">).</span>List<span class="op">(</span>context<span class="op">.</span>TODO<span class="op">(),</span> v1<span class="op">.</span>ListOptions<span class="op">{})</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;Error listing jobs: %v</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _<span class="op">,</span> job <span class="op">:=</span> <span class="kw">range</span> jobs<span class="op">.</span>Items <span class="op">{</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> job<span class="op">.</span>Status<span class="op">.</span>Succeeded <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>                    err <span class="op">=</span> clientset<span class="op">.</span>BatchV1<span class="op">().</span>Jobs<span class="op">(</span>job<span class="op">.</span>Namespace<span class="op">).</span>Delete<span class="op">(</span>context<span class="op">.</span>TODO<span class="op">(),</span> job<span class="op">.</span>Name<span class="op">,</span> v1<span class="op">.</span>DeleteOptions<span class="op">{})</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>                        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;Error deleting job %s: %v</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> job<span class="op">.</span>Name<span class="op">,</span> err<span class="op">)</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>                        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;Deleted job %s</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> job<span class="op">.</span>Name<span class="op">)</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="explanation">Explanation</h3>
<ul>
<li>This code sets up a simple Kubernetes controller. It checks for
completed Jobs every 30 seconds.</li>
<li>It lists all Jobs in the cluster and deletes those that have a
<code>Succeeded</code> status greater than zero.</li>
<li>We should run the controller in a place where it has permission to
delete Jobs.</li>
</ul>
<h3 id="deploying-the-controller">Deploying the Controller</h3>
<ul>
<li>We need to build our Go application and create a Docker image for
our controller.</li>
<li>We can deploy it to our Kubernetes cluster using a Deployment or as
a standalone Pod.</li>
</ul>
<h3 id="permissions">Permissions</h3>
<p>We must give our controller enough permissions by creating a Role and
RoleBinding:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> rbac.authorization.k8s.io/v1</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Role</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> job-cleaner</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">apiGroups</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;batch&quot;</span><span class="kw">]</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">resources</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;jobs&quot;</span><span class="kw">]</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">verbs</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;get&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;list&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;delete&quot;</span><span class="kw">]</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> rbac.authorization.k8s.io/v1</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> RoleBinding</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> job-cleaner-binding</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="fu">subjects</span><span class="kw">:</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> ServiceAccount</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">roleRef</span><span class="kw">:</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> Role</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> job-cleaner</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">apiGroup</span><span class="kw">:</span><span class="at"> rbac.authorization.k8s.io</span></span></code></pre></div>
<p>With this setup, our custom Kubernetes controller will clean up
completed Jobs made by CronJobs automatically. For more information on
managing Jobs and CronJobs, we can check <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-run-batch-jobs-in-kubernetes-with-jobs-and-cronjobs.html">running
batch jobs in Kubernetes</a>.</p>
<h2
id="leveraging-kubernetes-garbage-collection-for-job-management">Leveraging
Kubernetes Garbage Collection for Job Management</h2>
<p>Kubernetes has a built-in garbage collection feature. It helps us
manage resources better. It automatically removes completed Jobs created
by CronJobs. We can control this process by using job specifications and
a retention policy. This way, we make sure resources are not wasted.</p>
<h3 id="automatic-cleanup-with-garbage-collection">Automatic Cleanup
with Garbage Collection</h3>
<p>To let Kubernetes clean up completed Jobs by itself, we need to do
the following:</p>
<ol type="1">
<li><p><strong>Set <code>ttlSecondsAfterFinished</code></strong>: This
option in the Job spec tells how long a Job stays after it finishes.
After this time, Kubernetes will delete the Job.</p>
<p>Example:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> batch/v1</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Job</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> example-job</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ttlSecondsAfterFinished</span><span class="kw">:</span><span class="at"> </span><span class="dv">3600</span><span class="co">  # Job will be deleted 1 hour after finish</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> example</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> example-image</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> Never</span></span></code></pre></div></li>
<li><p><strong>Configure CronJob to Use TTL</strong>: When we make a
CronJob, we can add the <code>ttlSecondsAfterFinished</code> in the Job
template:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> batch/v1</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> CronJob</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> example-cronjob</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;*/5 * * * *&quot;</span><span class="co">  # Runs every 5 minutes</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">jobTemplate</span><span class="kw">:</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ttlSecondsAfterFinished</span><span class="kw">:</span><span class="at"> </span><span class="dv">1800</span><span class="co">  # Job will be deleted 30 minutes after finish</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> example</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">image</span><span class="kw">:</span><span class="at"> example-image</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> Never</span></span></code></pre></div></li>
</ol>
<h3 id="benefits-of-using-garbage-collection">Benefits of Using Garbage
Collection</h3>
<ul>
<li><strong>Resource Efficiency</strong>: Automatically deleting
completed Jobs helps reduce clutter. It saves cluster resources.</li>
<li><strong>Simplified Management</strong>: We do not have to delete
Jobs by hand. This makes our tasks easier.</li>
<li><strong>Retention Customization</strong>: By setting
<code>ttlSecondsAfterFinished</code>, we can change how long Jobs stay
based on what we need.</li>
</ul>
<p>Kubernetes garbage collection helps us manage Job resources well. It
keeps our systems efficient and tidy. For more about Kubernetes Jobs and
how to manage them, check <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-run-batch-jobs-in-kubernetes-with-jobs-and-cronjobs.html">this
article on running batch jobs</a>.</p>
<h2
id="automating-cleanup-with-custom-scripts-for-kubernetes-jobs">Automating
Cleanup with Custom Scripts for Kubernetes Jobs</h2>
<p>We can automate the cleanup of completed Kubernetes Jobs made by a
CronJob. To do this, we can use custom scripts. These scripts can run on
a set schedule or be triggered by Kubernetes events. Here is a simple
way to use a Bash script that removes completed Jobs that are older than
a certain age.</p>
<h3 id="bash-script-example">Bash Script Example</h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the namespace and age threshold (in seconds)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="va">NAMESPACE</span><span class="op">=</span><span class="st">&quot;default&quot;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="va">AGE_THRESHOLD</span><span class="op">=</span>3600  <span class="co"># 1 hour</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the current time</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="va">CURRENT_TIME</span><span class="op">=</span><span class="va">$(</span><span class="fu">date</span> +%s<span class="va">)</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># List completed jobs and their creation times</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get jobs <span class="at">-n</span> <span class="va">$NAMESPACE</span> <span class="at">--field-selector</span><span class="op">=</span>status.success=1,status.failed=0 <span class="at">-o</span> json <span class="kw">|</span> <span class="ex">jq</span> <span class="at">-c</span> <span class="st">&#39;.items[]&#39;</span> <span class="kw">|</span> <span class="cf">while</span> <span class="bu">read</span> <span class="va">job</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">JOB_NAME</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="va">$job</span> <span class="kw">|</span> <span class="ex">jq</span> <span class="at">-r</span> <span class="st">&#39;.metadata.name&#39;</span><span class="va">)</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">CREATION_TIME</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="va">$job</span> <span class="kw">|</span> <span class="ex">jq</span> <span class="at">-r</span> <span class="st">&#39;.metadata.creationTimestamp&#39;</span><span class="va">)</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">CREATION_TIME_SECONDS</span><span class="op">=</span><span class="va">$(</span><span class="fu">date</span> <span class="at">-d</span> <span class="va">$CREATION_TIME</span> +%s<span class="va">)</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate job age</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">JOB_AGE</span><span class="op">=</span><span class="va">$((CURRENT_TIME</span> <span class="op">-</span> <span class="va">CREATION_TIME_SECONDS))</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the job is older than the threshold</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">[</span> <span class="va">$JOB_AGE</span> <span class="ot">-gt</span> <span class="va">$AGE_THRESHOLD</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;Deleting job: </span><span class="va">$JOB_NAME</span><span class="st"> (Age: </span><span class="va">$JOB_AGE</span><span class="st"> seconds)&quot;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="ex">kubectl</span> delete job <span class="va">$JOB_NAME</span> <span class="at">-n</span> <span class="va">$NAMESPACE</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<h3 id="usage">Usage</h3>
<ol type="1">
<li><p><strong>Save the script</strong>: Save this script as
<code>cleanup_jobs.sh</code>.</p></li>
<li><p><strong>Make it executable</strong>: Run
<code>chmod +x cleanup_jobs.sh</code>.</p></li>
<li><p><strong>Add to cron</strong>: Schedule this script to run when
you want (for example, every hour) by adding it to your crontab:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crontab</span> <span class="at">-e</span></span></code></pre></div>
<p>Add this line to run the script every hour:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span> <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> /path/to/cleanup_jobs.sh</span></code></pre></div></li>
</ol>
<h3 id="notes">Notes</h3>
<ul>
<li>Make sure you have <code>kubectl</code> and <code>jq</code>
installed and set up to access your Kubernetes cluster.</li>
<li>Change the <code>AGE_THRESHOLD</code> variable if you want to set a
different age for when a Job can be deleted.</li>
<li>This script looks for Jobs in the specified namespace. Change the
<code>NAMESPACE</code> variable if needed.</li>
<li>For more complex cleanup tasks, you can add better error handling
and logging to the script.</li>
</ul>
<p>We can manage Kubernetes Jobs made by CronJobs easily with this
method. This keeps our cluster clean and without extra resources. For
more details on managing Kubernetes Jobs, see this article on <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-run-batch-jobs-in-kubernetes-with-jobs-and-cronjobs.html">running
batch jobs in Kubernetes</a>.</p>
<h2 id="frequently-asked-questions">Frequently Asked Questions</h2>
<h3
id="how-can-we-automatically-clean-up-completed-kubernetes-jobs-created-by-a-cronjob">1.
How can we automatically clean up completed Kubernetes Jobs created by a
CronJob?</h3>
<p>We can automatically remove completed Kubernetes Jobs made by a
CronJob by using the TTL feature. We set the
<code>ttlSecondsAfterFinished</code> field in the Job specification.
Kubernetes will delete Jobs after the time we set when they are
finished. This helps us manage resources and keep our cluster clean
without doing it by hand.</p>
<h3 id="what-is-the-retention-policy-for-kubernetes-jobs">2. What is the
retention policy for Kubernetes Jobs?</h3>
<p>Kubernetes Jobs have a default rule that keeps completed Jobs forever
unless we change it. We can change this by using the
<code>ttlSecondsAfterFinished</code> field for automatic cleanup or by
making a custom controller to set more complex rules. Knowing this rule
helps us manage resources better in our clusters.</p>
<h3 id="how-does-ttl-work-for-finished-jobs-in-kubernetes">3. How does
TTL work for finished Jobs in Kubernetes?</h3>
<p>TTL means Time To Live. It is a feature in Kubernetes that lets us
set a time after which a finished Job will be deleted automatically. We
can set this time using the <code>ttlSecondsAfterFinished</code>
attribute. When the Job finishes, Kubernetes starts a timer. After the
time runs out, it removes the Job from the cluster. This helps us manage
resources well.</p>
<h3 id="can-we-use-custom-scripts-to-clean-up-kubernetes-jobs">4. Can we
use custom scripts to clean up Kubernetes Jobs?</h3>
<p>Yes, we can use custom scripts to help clean up completed Kubernetes
Jobs. By using tools like <code>kubectl</code> in a cron job or
scheduled task, we can run commands that list and delete Jobs based on
what we want, like how old they are or if they are done. This gives us a
flexible way to manage Kubernetes resources.</p>
<h3
id="what-role-does-kubernetes-garbage-collection-play-in-job-management">5.
What role does Kubernetes garbage collection play in job
management?</h3>
<p>Kubernetes garbage collection helps us clean up resources by removing
things we do not need anymore. For Jobs, it works with TTL settings to
make sure completed Jobs get cleaned up well. This reduces the use of
resources. Understanding how garbage collection works can help us make
our Kubernetes environment better.</p>
<p>For more details on Kubernetes Jobs and how to manage them, check our
article on <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-run-batch-jobs-in-kubernetes-with-jobs-and-cronjobs.html">how
to run batch jobs in Kubernetes with Jobs and CronJobs</a>.</p>

                        </div>

                    </div>
                    <!--//container-->
                </article>

            </div>
            <!--//main-wrapper-->

            <div id="footer-placeholder"></div>

            <!-- Javascript -->
            <script src="/assets/plugins/popper.min.js" defer></script>
            <script src="/assets/plugins/bootstrap/js/bootstrap.min.js" defer></script>
            <script src="/assets/fontawesome/js/all.min.js" defer></script>
        </body>

        </html>
            
            