
    
            <!DOCTYPE html>
        <html lang="en">

        <head>
            <!-- Google tag (gtag.js) -->
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-TFCQEJR7TD"></script>
            <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-TFCQEJR7TD');
            </script>
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            
            <meta property="og:title" content="How can you monitor disk usage of Kubernetes persistent volumes?" />
            <meta property="og:description" content="Learn effective methods to monitor disk usage of Kubernetes persistent volumes and optimize your storage management strategy." />
            <meta property="og:url" content="https://www.bestonlinetutorial.com/kubernetes/how-can-you-monitor-disk-usage-of-kubernetes-persistent-volumes.html" />
            <link rel="canonical" href="https://www.bestonlinetutorial.com/kubernetes/how-can-you-monitor-disk-usage-of-kubernetes-persistent-volumes.html">
            <meta property="og:type" content="article" />
            <meta property="og:site_name" content=“BestOnlineTutorial” />
            <meta name="twitter:title" content="How can you monitor disk usage of Kubernetes persistent volumes?" />
            <meta name="twitter:description" content="Learn effective methods to monitor disk usage of Kubernetes persistent volumes and optimize your storage management strategy." />
            <meta name="pinterest-rich-pin" content="true" />

            <script type="application/ld+json">
                {
                "@context": "https://schema.org",
                "@type": "WebSite",
                "name": "BestOnlineTutorial",
                "url": "https://www.bestonlinetutorial.com/"
                }
            </script>
            <!-- Common CSS & Icons -->
            <link rel="icon" href="/favicon.ico" type="image/x-icon">
            <link rel="stylesheet" href="/assets/plugins/highlight/styles/monokai-sublime.css">
            <link id="theme-style" rel="stylesheet" href="/assets/css/theme-8.css">
            <link rel="stylesheet" href="/assets/css/post.css">
            <title>How can you monitor disk usage of Kubernetes persistent volumes?</title>
            <meta name="description" content="Learn effective methods to monitor disk usage of Kubernetes persistent volumes and optimize your storage management strategy.">
            <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	        <script src="/assets/js/blog.js"></script>
        </head>

        <body>

            <div id="header-placeholder"></div>

            <div class="main-wrapper">

                <article class="blog-post px-3 py-5 p-md-5">
                    <div class="container single-col-max-width">
                        <header class="blog-post-header">
                            <h1 class="title mb-2">How can you monitor disk usage of Kubernetes persistent volumes?</h1>
                        </header>

                        <div class="blog-post-body">
                            <p>Monitoring disk usage of Kubernetes persistent volumes is very
important. It helps us keep our applications running well. To track disk
usage in Kubernetes, we can use tools and methods like Kubernetes
Metrics Server, Prometheus with Grafana, custom scripts, and some
StorageClass settings. These tools give us a clear view of our
persistent volume storage. This way, we can avoid problems like using
too many resources or running out of space.</p>
<p>In this article, we will look at different ways to monitor disk usage
of Kubernetes persistent volumes. We will show how to use Kubernetes
Metrics Server for live metrics. We will also explain how to set up
Prometheus and Grafana for better monitoring. We will talk about making
custom scripts for our specific needs. We will discuss how to use
StorageClass features for good visibility. Lastly, we will cover how to
set up alerts to manage disk usage before it becomes a problem. Here are
the solutions we will cover:</p>
<ul>
<li>How to Monitor Disk Usage of Kubernetes Persistent Volumes</li>
<li>How Can You Use Kubernetes Metrics Server to Monitor Disk Usage of
Persistent Volumes</li>
<li>How Can You Leverage Prometheus and Grafana for Monitoring Disk
Usage of Kubernetes Persistent Volumes</li>
<li>How Can You Implement Custom Scripts for Monitoring Disk Usage of
Kubernetes Persistent Volumes</li>
<li>How Can You Utilize StorageClass with Monitoring Features for
Kubernetes Persistent Volumes</li>
<li>How Can You Set Up Alerts for Disk Usage of Kubernetes Persistent
Volumes</li>
</ul>
<p>For more information on Kubernetes and what it can do, you can read
articles like <a
href="https://bestonlinetutorial.com/kubernetes/what-are-persistent-volumes-and-persistent-volume-claims.html">What
are Kubernetes Persistent Volumes and Persistent Volume Claims</a> and
<a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-monitor-my-kubernetes-cluster.html">How
do I Monitor My Kubernetes Cluster</a>.</p>
<h2
id="how-can-we-use-kubernetes-metrics-server-to-monitor-disk-usage-of-persistent-volumes">How
Can We Use Kubernetes Metrics Server to Monitor Disk Usage of Persistent
Volumes</h2>
<p>Kubernetes Metrics Server helps us get resource metrics from our
cluster. This includes CPU and memory usage. But it does not directly
collect disk usage metrics for Persistent Volumes (PVs). To watch disk
usage well, we can use Metrics Server together with other tools or
methods.</p>
<h3 id="installation-of-metrics-server">Installation of Metrics
Server</h3>
<p>First, we need to make sure that Metrics Server is installed in our
Kubernetes cluster. We can deploy it with this command:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span></code></pre></div>
<h3 id="checking-metrics">Checking Metrics</h3>
<p>After we install it, we can check if the Metrics Server is working
right by running:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get <span class="at">--raw</span> <span class="st">&quot;/apis/metrics.k8s.io/v1beta1/pods&quot;</span> <span class="kw">|</span> <span class="ex">jq</span> .</span></code></pre></div>
<p>This command gets the metrics for all pods. To check disk usage, we
need other ways, because Metrics Server does not give this information
by itself.</p>
<h3 id="alternatives-for-monitoring-disk-usage">Alternatives for
Monitoring Disk Usage</h3>
<ol type="1">
<li><p><strong>Kubelet Metrics</strong>: Kubelet shows metrics that
include disk usage. We can access these metrics through the Kubelet API.
We must enable the metrics by setting the
<code>--read-only-port</code>.</p></li>
<li><p><strong>Using <code>df</code> Command in a Pod</strong>: We can
run shell commands inside a pod to check the disk usage directly. For
example:</p></li>
</ol>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> exec <span class="at">-it</span> <span class="op">&lt;</span>pod-name<span class="op">&gt;</span> -- df <span class="at">-h</span></span></code></pre></div>
<ol start="3" type="1">
<li><strong>Filesystem Monitoring Tools</strong>: We can use monitoring
tools like <code>Prometheus Node Exporter</code> or
<code>cAdvisor</code> to collect and show disk usage metrics over time.
We can deploy Node Exporter like this:</li>
</ol>
<div class="sourceCode" id="cb4"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> node-exporter</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> node-exporter</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> node-exporter</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> node-exporter</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> prom/node-exporter</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">9100</span></span></code></pre></div>
<ol start="4" type="1">
<li><strong>Custom Metrics</strong>: We can create custom metrics using
the Kubernetes API to track disk usage and send them to Prometheus.</li>
</ol>
<h3 id="accessing-metrics-in-grafana">Accessing Metrics in Grafana</h3>
<p>After we collect the metrics using Node Exporter or similar tools, we
can see them in Grafana. We can create a dashboard and query for disk
usage metrics like <code>node_filesystem_avail_bytes</code> and
<code>node_filesystem_size_bytes</code>.</p>
<p>These methods help us to monitor the disk usage of Kubernetes
Persistent Volumes well, even if the Metrics Server does not provide
this directly. For more help on setting up monitoring in Kubernetes, we
can check <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-monitor-my-kubernetes-cluster.html">this
article</a>.</p>
<h2
id="how-can-we-leverage-prometheus-and-grafana-for-monitoring-disk-usage-of-kubernetes-persistent-volumes">How
Can We Leverage Prometheus and Grafana for Monitoring Disk Usage of
Kubernetes Persistent Volumes</h2>
<p>To monitor disk usage of Kubernetes persistent volumes with
Prometheus and Grafana, we can follow these steps:</p>
<ol type="1">
<li><p><strong>Install Prometheus and Grafana</strong>: We can deploy
both tools on our Kubernetes cluster using Helm charts.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">helm</span> repo add prometheus-community https://prometheus-community.github.io/helm-charts</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">helm</span> repo update</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">helm</span> install prometheus prometheus-community/prometheus</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">helm</span> install grafana grafana/grafana</span></code></pre></div></li>
<li><p><strong>Configure Prometheus to Monitor Persistent
Volumes</strong>: We need to edit Prometheus configuration to scrape
metrics from the kubelet. This will help us collect disk usage
statistics.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> ConfigMap</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> prometheus-kube-prometheus-prometheus</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">  prometheus.yaml</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    scrape_configs:</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      - job_name: &#39;kubernetes-nodes&#39;</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        kubernetes_sd_configs:</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>          - role: node</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        relabel_configs:</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>          - source_labels: [__meta_kubernetes_node_name]</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>            action: keep</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            regex: .*</span></code></pre></div></li>
<li><p><strong>Deploy Node Exporter</strong>: Node Exporter helps us
collect metrics like disk usage. We can install it using Helm.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">helm</span> install node-exporter prometheus-community/prometheus-node-exporter</span></code></pre></div></li>
<li><p><strong>Access Disk Usage Metrics</strong>: We can use these
PromQL queries in Prometheus to get persistent volume metrics:</p>
<ul>
<li>Total disk usage of a specific persistent volume:</li>
</ul>
<pre class="promql"><code>sum(kube_persistentvolume_claims_used_bytes{persistentvolumeclaim=&quot;&lt;PVC_NAME&gt;&quot;})</code></pre>
<ul>
<li>Free disk space available:</li>
</ul>
<pre class="promql"><code>sum(kube_persistentvolume_capacity_bytes{persistentvolumeclaim=&quot;&lt;PVC_NAME&gt;&quot;}) - sum(kube_persistentvolume_claims_used_bytes{persistentvolumeclaim=&quot;&lt;PVC_NAME&gt;&quot;})</code></pre></li>
<li><p><strong>Set Up Grafana Dashboards</strong>: After we deploy
Grafana, we can access it via a web browser (default port 3000) and add
Prometheus as a data source.</p>
<ul>
<li>Go to <strong>Configuration &gt; Data Sources</strong> and select
Prometheus.</li>
<li>Set the URL to <code>http://prometheus-server:80</code> and
save.</li>
</ul></li>
<li><p><strong>Create Dashboards</strong>: We can use this query to
visualize persistent volume disk usage in Grafana:</p>
<pre class="promql"><code>kube_persistentvolume_claims_used_bytes{persistentvolumeclaim=&quot;&lt;PVC_NAME&gt;&quot;}</code></pre>
<ul>
<li>We can create panels for total usage, free space, and trends over
time.</li>
</ul></li>
<li><p><strong>Alerting</strong>: We can set alerts in Prometheus for
disk usage thresholds. For example, to alert when usage goes over
80%:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">groups</span><span class="kw">:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> persistent-volume-alerts</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">alert</span><span class="kw">:</span><span class="at"> DiskUsageHigh</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">expr</span><span class="kw">:</span><span class="at"> (sum(kube_persistentvolume_claims_used_bytes{persistentvolumeclaim=&quot;&lt;PVC_NAME&gt;&quot;}) / sum(kube_persistentvolume_capacity_bytes{persistentvolumeclaim=&quot;&lt;PVC_NAME&gt;&quot;}) * 100) &gt; 80</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">for</span><span class="kw">:</span><span class="at"> 5m</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">severity</span><span class="kw">:</span><span class="at"> warning</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">summary</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Disk usage high on PVC {{ $labels.persistentvolumeclaim }}&quot;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Disk usage exceeds 80% on persistent volume claim {{ $labels.persistentvolumeclaim }}&quot;</span></span></code></pre></div></li>
</ol>
<p>By following these steps, we can use Prometheus and Grafana to
monitor disk usage of Kubernetes persistent volumes well. For more
details on monitoring techniques, we can check <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-monitor-my-kubernetes-cluster.html">how
to monitor my Kubernetes cluster</a>.</p>
<h2
id="how-can-we-implement-custom-scripts-for-monitoring-disk-usage-of-kubernetes-persistent-volumes">How
Can We Implement Custom Scripts for Monitoring Disk Usage of Kubernetes
Persistent Volumes</h2>
<p>To monitor disk usage of Kubernetes persistent volumes (PVs) with
custom scripts, we can use basic Linux commands and Kubernetes API
commands. Here is a simple way to implement these scripts.</p>
<h3 id="example-script-using-kubectl-and-df">Example Script using
<code>kubectl</code> and <code>df</code></h3>
<p>This example script gets the usage of persistent volumes in our
Kubernetes cluster. It runs commands inside a pod that mounts the
PVs.</p>
<ol type="1">
<li><strong>Create a Script</strong>: Save the script below as
<code>monitor_pv_usage.sh</code>.</li>
</ol>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Name of the pod to check</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="va">POD_NAME</span><span class="op">=&lt;</span>your-pod-name<span class="op">&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="va">NAMESPACE</span><span class="op">=&lt;</span>your-namespace<span class="op">&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the list of persistent volumes</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pvc <span class="at">-n</span> <span class="va">$NAMESPACE</span> <span class="at">-o</span> jsonpath=<span class="st">&#39;{.items[*].metadata.name}&#39;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="st">&#39; &#39;</span> <span class="st">&#39;\n&#39;</span> <span class="kw">|</span> <span class="cf">while</span> <span class="bu">read</span> <span class="va">pvc</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the pod using this PVC</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">POD</span><span class="op">=</span><span class="va">$(</span><span class="ex">kubectl</span> get pod <span class="at">-n</span> <span class="va">$NAMESPACE</span> <span class="at">--field-selector</span><span class="op">=</span>status.phase=Running <span class="at">-o</span> jsonpath=<span class="st">&quot;{.items[?(@.spec.volumes[*].persistentVolumeClaim.claimName==&#39;</span><span class="va">$pvc</span><span class="st">&#39;)].metadata.name}&quot;</span><span class="va">)</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">[</span> <span class="ot">-n</span> <span class="st">&quot;</span><span class="va">$POD</span><span class="st">&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Checking disk usage for PVC: </span><span class="va">$pvc</span><span class="st"> in Pod: </span><span class="va">$POD</span><span class="st">&quot;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Execute df command inside the pod</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">kubectl</span> exec <span class="at">-n</span> <span class="va">$NAMESPACE</span> <span class="va">$POD</span> <span class="at">--</span> df <span class="at">-h</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;No running pod found for PVC: </span><span class="va">$pvc</span><span class="st">&quot;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<ol start="2" type="1">
<li><strong>Make the Script Executable</strong>:</li>
</ol>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x monitor_pv_usage.sh</span></code></pre></div>
<ol start="3" type="1">
<li><strong>Run the Script</strong>:</li>
</ol>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./monitor_pv_usage.sh</span></span></code></pre></div>
<h3 id="using-cronjobs-for-regular-monitoring">Using CronJobs for
Regular Monitoring</h3>
<p>To make this process automatic, we can set up a Kubernetes CronJob.
This job runs the script at regular times.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> batch/v1</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> CronJob</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> pv-monitor</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;*/30 * * * *&quot;</span><span class="co">  # Change the schedule as needed</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">jobTemplate</span><span class="kw">:</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> pv-monitor</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">image</span><span class="kw">:</span><span class="at"> alpine:latest</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;/bin/sh&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;-c&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;/path/to/monitor_pv_usage.sh&quot;</span><span class="kw">]</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> scripts</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /path/to/</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> OnFailure</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> scripts</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">configMap</span><span class="kw">:</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">name</span><span class="kw">:</span><span class="at"> pv-monitor-scripts</span></span></code></pre></div>
<h3 id="create-a-configmap-for-the-script">Create a ConfigMap for the
Script</h3>
<p>Before we deploy the CronJob, we need to create a ConfigMap that has
our script:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> create configmap pv-monitor-scripts <span class="at">--from-file</span><span class="op">=</span>monitor_pv_usage.sh <span class="at">-n</span> <span class="op">&lt;</span>your-namespace<span class="op">&gt;</span></span></code></pre></div>
<h3 id="monitor-disk-usage-with-node-exporter">Monitor Disk Usage with
Node Exporter</h3>
<p>For a better solution, we can use Prometheus Node Exporter to gather
disk usage metrics, including for persistent volumes. We should install
Node Exporter in our cluster and set it to scrape metrics from our
nodes.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> node-exporter</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> node-exporter</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> node-exporter</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> node-exporter</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> prom/node-exporter</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">9100</span></span></code></pre></div>
<h3 id="accessing-metrics">Accessing Metrics</h3>
<p>We can access the metrics through Prometheus. We can also use Grafana
dashboards to see the disk usage of our persistent volumes.</p>
<p>Implementing custom scripts to monitor disk usage of Kubernetes
persistent volumes helps us automate the process. It also gives us
insights that fit our environment. For more details on integrating and
monitoring Kubernetes resources, we can check <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-monitor-my-kubernetes-cluster.html">how
to monitor my Kubernetes cluster</a>.</p>
<h2
id="how-can-we-utilize-storageclass-with-monitoring-features-for-kubernetes-persistent-volumes">How
Can We Utilize StorageClass with Monitoring Features for Kubernetes
Persistent Volumes</h2>
<p>In Kubernetes, <code>StorageClass</code> helps us define different
types of storage. This can include settings for automatic storage setup
and monitoring features. To use <code>StorageClass</code> with
monitoring for Kubernetes Persistent Volumes (PVs), we can follow these
steps:</p>
<ol type="1">
<li><p><strong>Define a StorageClass</strong>: First, we create a
<code>StorageClass</code> that has settings for monitoring metrics. For
example, if we use a storage provider that allows monitoring, we can add
the right attributes.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> storage.k8s.io/v1</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> StorageClass</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> monitored-storage</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">provisioner</span><span class="kw">:</span><span class="at"> your-provisioner</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">parameters</span><span class="kw">:</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">monitor</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;true&quot;</span><span class="co">  # This turns on monitoring</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;gp2&quot;</span><span class="co">      # This is an example storage type for AWS</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">reclaimPolicy</span><span class="kw">:</span><span class="at"> Delete</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="fu">volumeBindingMode</span><span class="kw">:</span><span class="at"> WaitForFirstConsumer</span></span></code></pre></div></li>
<li><p><strong>Create PersistentVolumeClaim (PVC)</strong>: Next, we use
the <code>StorageClass</code> in a PVC to ask for storage with
monitoring features.</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> PersistentVolumeClaim</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> monitored-pvc</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">accessModes</span><span class="kw">:</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> ReadWriteOnce</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">storage</span><span class="kw">:</span><span class="at"> 10Gi</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">storageClassName</span><span class="kw">:</span><span class="at"> monitored-storage</span></span></code></pre></div></li>
<li><p><strong>Monitor Disk Usage</strong>: After the PVC is linked to a
PV, we can use monitoring tools like Prometheus to get metrics about
disk usage. We need to make sure that the monitoring tool is set up to
collect data from the storage provider.</p>
<p>Here is an example of a Prometheus setup:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">scrape_configs</span><span class="kw">:</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">job_name</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;kubernetes-storage&#39;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">kubernetes_sd_configs</span><span class="kw">:</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">role</span><span class="kw">:</span><span class="at"> endpoints</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">relabel_configs</span><span class="kw">:</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">source_labels</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">__meta_kubernetes_service_name</span><span class="kw">]</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">action</span><span class="kw">:</span><span class="at"> keep</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">regex</span><span class="kw">:</span><span class="at"> monitored-storage</span></span></code></pre></div></li>
<li><p><strong>Integrate with Grafana</strong>: We can make dashboards
in Grafana to show the metrics we collect from the storage volumes. We
use the Prometheus data source to get data about disk usage, IOPS, and
latency.</p>
<p>Here is an example query in Grafana:</p>
<pre class="promql"><code>rate(storage_usage_bytes{storage_class=&quot;monitored-storage&quot;}[5m])</code></pre></li>
<li><p><strong>Enable Alerts</strong>: We should set up alerts in
Prometheus for important limits related to disk usage. For example, we
can alert when usage goes over 80%.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">groups</span><span class="kw">:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> storage-alerts</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">alert</span><span class="kw">:</span><span class="at"> HighDiskUsage</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">expr</span><span class="kw">:</span><span class="at"> (storage_usage_bytes{storage_class=&quot;monitored-storage&quot;} / storage_capacity_bytes{storage_class=&quot;monitored-storage&quot;}) * 100 &gt; 80</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">for</span><span class="kw">:</span><span class="at"> 5m</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">severity</span><span class="kw">:</span><span class="at"> critical</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">summary</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;High disk usage detected&quot;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Disk usage is above 80% for monitored-storage&quot;</span></span></code></pre></div></li>
</ol>
<p>By setting up <code>StorageClass</code> with monitoring features and
using tools like Prometheus and Grafana, we can watch the disk usage of
Kubernetes persistent volumes. This way, we get a better view of storage
performance and how to manage capacity.</p>
<p>For more on Kubernetes storage options, check <a
href="https://bestonlinetutorial.com/kubernetes/what-are-different-kubernetes-storage-options.html">what
are different Kubernetes storage options</a>.</p>
<h2
id="how-can-we-set-up-alerts-for-disk-usage-of-kubernetes-persistent-volumes">How
Can We Set Up Alerts for Disk Usage of Kubernetes Persistent
Volumes</h2>
<p>To monitor disk usage of Kubernetes persistent volumes well, we need
to set up alerts. This helps us manage storage resources before they
cause problems for our applications. Here is how we can set up
alerts.</p>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>We should have a monitoring stack ready, like Prometheus and
Grafana.</li>
<li>Make sure the persistent volume metrics are collected.</li>
</ul>
<h3 id="step-by-step-guide">Step-by-step Guide</h3>
<ol type="1">
<li><p><strong>Prometheus Configuration</strong>: We change the
Prometheus configuration to scrape metrics from our Kubernetes nodes. We
need to include the persistent volume metrics.</p>
<p>Example configuration snippet in <code>prometheus.yml</code>:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">scrape_configs</span><span class="kw">:</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">job_name</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;kubernetes-nodes&#39;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">kubernetes_sd_configs</span><span class="kw">:</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">role</span><span class="kw">:</span><span class="at"> node</span></span></code></pre></div></li>
<li><p><strong>Creating Alerting Rules</strong>:</p>
<p>We define alerting rules in a new YAML file. For example, we can set
an alert when disk usage goes over a specific limit, like 80%.</p>
<p>Example alerting rule (<code>alerts.yaml</code>):</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">groups</span><span class="kw">:</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> persistent-volume-alerts</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">alert</span><span class="kw">:</span><span class="at"> DiskUsageHigh</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">expr</span><span class="kw">:</span><span class="at"> (node_filesystem_avail_bytes{fstype!~&quot;overlay|tmpfs&quot;} / node_filesystem_size_bytes{fstype!~&quot;overlay|tmpfs&quot;}) &lt; 0.2</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">for</span><span class="kw">:</span><span class="at"> 5m</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">severity</span><span class="kw">:</span><span class="at"> warning</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">summary</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;High Disk Usage on {{ $labels.instance }}&quot;</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Disk usage is above 80% for the persistent volume.&quot;</span></span></code></pre></div></li>
<li><p><strong>Configuring Alertmanager</strong>: We set up Alertmanager
to manage alerts from Prometheus. We configure notification channels
like email, Slack, or PagerDuty.</p>
<p>Example <code>alertmanager.yml</code> configuration:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">global</span><span class="kw">:</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">resolve_timeout</span><span class="kw">:</span><span class="at"> 5m</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">route</span><span class="kw">:</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">group_by</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&#39;alertname&#39;</span><span class="kw">]</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">group_wait</span><span class="kw">:</span><span class="at"> 30s</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">group_interval</span><span class="kw">:</span><span class="at"> 5m</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">repeat_interval</span><span class="kw">:</span><span class="at"> 1h</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">receiver</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;slack-notifications&#39;</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="fu">receivers</span><span class="kw">:</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;slack-notifications&#39;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">slack_configs</span><span class="kw">:</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">channel</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;#alerts&#39;</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">text</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;{{ .Alerts }}&#39;</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">send_resolved</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span></code></pre></div></li>
<li><p><strong>Deploying the Configuration</strong>: We apply the
alerting rules and Alertmanager settings to our Prometheus setup.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> alerts.yaml</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> alertmanager.yml</span></code></pre></div></li>
<li><p><strong>Testing Alerts</strong>: We can simulate high disk usage
to check if alerts are working properly. We can fill the persistent
volume with data for a short time.</p></li>
</ol>
<h3 id="monitoring-in-grafana">Monitoring in Grafana</h3>
<p>After we set up alerts, we can see disk usage in Grafana. We create
dashboards that show persistent volume metrics and link alerts to show
when metrics are too high.</p>
<h3 id="conclusion">Conclusion</h3>
<p>We can set up alerts for disk usage of Kubernetes persistent volumes
with Prometheus and Alertmanager. This helps us manage our storage
resources well. Regular monitoring and quick alerts help us keep our
applications running smoothly.</p>
<h2 id="frequently-asked-questions">Frequently Asked Questions</h2>
<h3
id="how-do-we-check-the-disk-usage-of-kubernetes-persistent-volumes">1.
How do we check the disk usage of Kubernetes persistent volumes?</h3>
<p>To check the disk usage of Kubernetes persistent volumes, we can use
the <code>kubectl</code> command with metrics from the Kubernetes
Metrics Server. We use the command
<code>kubectl describe pv &lt;your-pv-name&gt;</code> to see details
about the persistent volume. This includes its capacity and usage. For
more detailed metrics, we can use a monitoring tool like Prometheus. It
helps us see disk usage trends over time.</p>
<h3 id="can-we-monitor-persistent-volume-claims-pvcs-in-kubernetes">2.
Can we monitor persistent volume claims (PVCs) in Kubernetes?</h3>
<p>Yes, we can monitor persistent volume claims (PVCs) in Kubernetes.
This is important to understand disk usage and performance. We can use
tools like Prometheus along with Grafana to see PVC metrics. We need to
set up the Prometheus adapter to collect metrics from PVCs. Then, we can
see them on Grafana dashboards. This allows us to monitor and analyze
storage use in real-time.</p>
<h3 id="what-tools-can-we-use-to-monitor-disk-space-in-kubernetes">3.
What tools can we use to monitor disk space in Kubernetes?</h3>
<p>We can use different tools to monitor disk space in Kubernetes.
Prometheus is a good choice for gathering metrics. Grafana helps us
visualize this data well. Also, the Kubernetes Metrics Server gives us
basic metrics about resource usage like disk space. For more automated
monitoring, we can use custom scripts or third-party solutions made for
Kubernetes environments.</p>
<h3
id="how-can-we-set-up-alerts-for-disk-usage-thresholds-on-persistent-volumes">4.
How can we set up alerts for disk usage thresholds on persistent
volumes?</h3>
<p>To set up alerts for disk usage thresholds on Kubernetes persistent
volumes, we can configure alert rules in Prometheus. We need to define
rules based on usage metrics. For example, we can trigger alerts when
usage goes over a certain percentage of total disk capacity. We can
connect with notification systems like Slack or email. This way, we get
instant alerts when disk usage thresholds are crossed.</p>
<h3
id="is-it-possible-to-automate-disk-usage-monitoring-for-kubernetes-persistent-volumes">5.
Is it possible to automate disk usage monitoring for Kubernetes
persistent volumes?</h3>
<p>Yes, it is easy to automate disk usage monitoring for Kubernetes
persistent volumes. We can use tools like Prometheus and custom scripts.
First, we set up Prometheus to scrape metrics from our cluster. Then, we
create alerting rules to notify us of any problems. Also, we can
schedule scripts to run regularly. These scripts check disk usage and
send reports or alerts based on set thresholds.</p>
<p>For more information on Kubernetes monitoring solutions, visit <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-monitor-my-kubernetes-cluster.html">How
do I monitor my Kubernetes cluster</a> to explore different methods and
tools for effective monitoring.</p>

                        </div>

                    </div>
                    <!--//container-->
                </article>

            </div>
            <!--//main-wrapper-->

            <div id="footer-placeholder"></div>

            <!-- Javascript -->
            <script src="/assets/plugins/popper.min.js" defer></script>
            <script src="/assets/plugins/bootstrap/js/bootstrap.min.js" defer></script>
            <script src="/assets/fontawesome/js/all.min.js" defer></script>
        </body>

        </html>
            
            