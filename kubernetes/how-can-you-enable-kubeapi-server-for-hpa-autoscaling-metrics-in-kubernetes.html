
    
            <!DOCTYPE html>
        <html lang="en">

        <head>
            <!-- Google tag (gtag.js) -->
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-TFCQEJR7TD"></script>
            <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-TFCQEJR7TD');
            </script>
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <!-- Common CSS & Icons -->
            <link rel="icon" href="/favicon.ico" type="image/x-icon">
            <link rel="stylesheet" href="/assets/plugins/highlight/styles/monokai-sublime.css">
            <link id="theme-style" rel="stylesheet" href="/assets/css/theme-8.css">
            <link rel="stylesheet" href="/assets/css/post.css">
            <title>How Can You Enable KubeAPI Server for HPA Autoscaling Metrics in Kubernetes?</title>
            <meta name="description" content="Learn how to enable KubeAPI Server for HPA autoscaling metrics in Kubernetes to optimize your cluster's performance effectively.">
            <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	        <script src="/assets/js/blog.js"></script>
        </head>

        <body>

            <div id="header-placeholder"></div>

            <div class="main-wrapper">

                <article class="blog-post px-3 py-5 p-md-5">
                    <div class="container single-col-max-width">
                        <header class="blog-post-header">
                            <h1 class="title mb-2">How Can You Enable KubeAPI Server for HPA Autoscaling Metrics in Kubernetes?</h1>
                        </header>

                        <div class="blog-post-body">
                            <p>To enable the KubeAPI Server for HPA autoscaling metrics in
Kubernetes, we need to set up the Metrics Server. Also, we have to make
sure the right API server flags are in place. This process helps the
Horizontal Pod Autoscaler (HPA) use resource metrics. It helps us scale
workloads better. This way, we can improve application performance and
use resources well. By following the steps given, we can easily add
autoscaling features to our Kubernetes setup.</p>
<p>In this article, we will talk about the important steps to enable the
KubeAPI Server for HPA autoscaling metrics in Kubernetes. We will look
at what we need first. Then, we will see how to configure the Metrics
Server. Next, we will explore how to use custom metrics. After that, we
will check how to enable KubeAPI Server flags. Finally, we will verify
HPA functionality. By the end, we will understand how to use autoscaling
metrics in our Kubernetes deployments.</p>
<ul>
<li>How to Enable KubeAPI Server for HPA Autoscaling Metrics in
Kubernetes</li>
<li>What Prerequisites Do You Need to Enable KubeAPI Server for HPA
Autoscaling Metrics in Kubernetes?</li>
<li>How Do You Configure Metrics Server for HPA Autoscaling Metrics in
Kubernetes?</li>
<li>How Can You Use Custom Metrics for HPA Autoscaling Metrics in
Kubernetes?</li>
<li>What Are the Steps to Enable KubeAPI Server Flags for HPA
Autoscaling Metrics in Kubernetes?</li>
<li>How Do You Verify HPA Functionality with KubeAPI Server for
Autoscaling Metrics in Kubernetes?</li>
<li>Frequently Asked Questions</li>
</ul>
<p>For more reading on Kubernetes and its features, check out this
helpful article on <a
href="https://bestonlinetutorial.com/kubernetes/what-is-kubernetes-and-how-does-it-simplify-container-management.html">what
Kubernetes is and how it simplifies container management</a>.</p>
<h2
id="what-prerequisites-do-we-need-to-enable-kubeapi-server-for-hpa-autoscaling-metrics-in-kubernetes">What
Prerequisites Do We Need to Enable KubeAPI Server for HPA Autoscaling
Metrics in Kubernetes?</h2>
<p>To enable the KubeAPI Server for Horizontal Pod Autoscaler (HPA)
autoscaling metrics in Kubernetes, we need to meet some
prerequisites:</p>
<ol type="1">
<li><p><strong>Kubernetes Version</strong>: We must check that we are
running a Kubernetes version that supports HPA with custom metrics.
Usually, Kubernetes version 1.6 and later supports HPA.</p></li>
<li><p><strong>Metrics Server</strong>: We should install and set up the
Metrics Server in our cluster. This part collects resource metrics from
Kubelets and shows them to the KubeAPI Server. We can install the
Metrics Server by using this command:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span></code></pre></div></li>
<li><p><strong>API Aggregation Layer</strong>: We need to make sure that
the KubeAPI Server is set up to use the API Aggregation Layer. We should
check that the <code>--requestheader-allowed-names</code> and
<code>--requestheader-client-ca-file</code> flags are set correctly in
the kube-apiserver configuration.</p></li>
<li><p><strong>Cluster Role and Role Binding</strong>: We have to create
a ClusterRole and ClusterRoleBinding for the Metrics Server. This allows
it to access metrics. We can use this YAML setup:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> rbac.authorization.k8s.io/v1</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> ClusterRole</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metrics-server</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">apiGroups</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;&quot;</span><span class="kw">]</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resources</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;pods&quot;</span><span class="kw">]</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">verbs</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;get&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;list&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;watch&quot;</span><span class="kw">]</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> rbac.authorization.k8s.io/v1</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> ClusterRoleBinding</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metrics-server</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">subjects</span><span class="kw">:</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> ServiceAccount</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metrics-server</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> kube-system</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="fu">roleRef</span><span class="kw">:</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> ClusterRole</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metrics-server</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">apiGroup</span><span class="kw">:</span><span class="at"> rbac.authorization.k8s.io</span></span></code></pre></div></li>
<li><p><strong>HPA API and Custom Metrics</strong>: If we want to use
custom metrics for HPA, we must make sure that the Custom Metrics API is
enabled on the KubeAPI Server. We can do this by using the
<code>--enable-aggregator-routing</code> flag.</p></li>
</ol>
<p>By meeting these requirements, we can enable the KubeAPI Server for
HPA autoscaling metrics. This will help our Kubernetes cluster to be
ready for scaling based on resource use.</p>
<h2
id="how-do-you-configure-metrics-server-for-hpa-autoscaling-metrics-in-kubernetes">How
Do You Configure Metrics Server for HPA Autoscaling Metrics in
Kubernetes?</h2>
<p>To set up the Metrics Server for Horizontal Pod Autoscaler (HPA)
autoscaling metrics in Kubernetes, we can follow these steps:</p>
<ol type="1">
<li><p><strong>Install Metrics Server</strong>: First, we need to use
this command to install the Metrics Server. Make sure we have access to
<code>kubectl</code> and a running Kubernetes cluster.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span></code></pre></div></li>
<li><p><strong>Check Metrics Server Installation</strong>: After we
install, we should check that the Metrics Server is running and
collecting metrics.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get deployment metrics-server <span class="at">-n</span> kube-system</span></code></pre></div>
<p>We can look at the logs to make sure it works fine:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> logs <span class="at">-n</span> kube-system deployment/metrics-server</span></code></pre></div></li>
<li><p><strong>Set Up API Aggregation Layer</strong>: We need to make
sure the KubeAPI server includes the Metrics API. If we use a custom
KubeAPI server, we might have to add these flags:</p>
<pre class="plaintext"><code>--request-timeout=1s
--enable-aggregation-layer=true</code></pre></li>
<li><p><strong>Change Resource Requests and Limits</strong>: We should
define resource requests and limits for our pods. This helps the Metrics
Server collect metrics right. For example:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> my-app</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> my-container</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> my-image</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> 200m</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> 512Mi</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> 500m</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> 1Gi</span></span></code></pre></div></li>
<li><p><strong>Test Metrics</strong>: We can run this command to see if
metrics are ready for our pods:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> top pods</span></code></pre></div></li>
<li><p><strong>Create HPA</strong>: Now, we need to create an HPA that
uses the metrics from the Metrics Server. Hereâ€™s one example:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> autoscaling/v2beta2</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> HorizontalPodAutoscaler</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> my-app-hpa</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">scaleTargetRef</span><span class="kw">:</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> my-app</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minReplicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">maxReplicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">metrics</span><span class="kw">:</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Resource</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resource</span><span class="kw">:</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cpu</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">target</span><span class="kw">:</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Utilization</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">averageUtilization</span><span class="kw">:</span><span class="at"> </span><span class="dv">50</span></span></code></pre></div></li>
<li><p><strong>Apply the HPA</strong>: Finally, we apply the HPA
configuration:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> my-app-hpa.yaml</span></code></pre></div></li>
</ol>
<p>This setup lets the Metrics Server collect and give CPU metrics. The
HPA can use these metrics to scale our application based on the load.
For more information about Kubernetes and its parts, we can check <a
href="https://bestonlinetutorial.com/kubernetes/what-are-the-key-components-of-a-kubernetes-cluster.html">What
are the key components of a Kubernetes cluster?</a>.</p>
<h2
id="how-can-we-use-custom-metrics-for-hpa-autoscaling-metrics-in-kubernetes">How
Can We Use Custom Metrics for HPA Autoscaling Metrics in
Kubernetes?</h2>
<p>To use custom metrics for Horizontal Pod Autoscaling (HPA) in
Kubernetes, we can follow these steps:</p>
<ol type="1">
<li><p><strong>Install the Metrics Server</strong>: We need to make sure
the Metrics Server is installed and working in our cluster. This server
gives resource metrics for HPA. We can use this command to deploy the
Metrics Server:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span></code></pre></div></li>
<li><p><strong>Define Custom Metrics</strong>: We can create custom
metrics using the Kubernetes API or a monitoring tool like Prometheus.
For example, if we use Prometheus, we can show metrics through an
endpoint in our application.</p></li>
<li><p><strong>Create a Custom Metrics API</strong>: We should implement
a custom metrics API or use existing ones like the Prometheus Adapter.
If we use the Prometheus Adapter, we need to set it up to show our
metrics to the Kubernetes API. Here is a sample setup:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> ConfigMap</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> prometheus-adapter-config</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> kube-system</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="fu">  config.yaml</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    rules:</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>      - series: &#39;http_requests_total&#39;</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        resources:</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>          overrides:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>            namespace:</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>              resource: &#39;namespace&#39;</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>            pod:</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>              resource: &#39;pod&#39;</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        metricsQuery: &#39;sum(rate(http_requests_total{namespace=&quot;{{ .Namespace }}&quot;, pod=&quot;{{ .Pod }}&quot;})[5m])&#39;</span></code></pre></div></li>
<li><p><strong>Deploy the Custom Metrics Adapter</strong>: We can use
Helm or kubectl to deploy the adapter. If we use Helm, the command might
look like this:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">helm</span> install prometheus-adapter prometheus-community/prometheus-adapter <span class="at">--namespace</span> kube-system</span></code></pre></div></li>
<li><p><strong>Configure HPA to Use Custom Metrics</strong>: We need to
define an HPA resource that uses our custom metric. Here is an example
HPA setup that scales based on a custom metric called
<code>http_requests</code>:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> autoscaling/v2beta2</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> HorizontalPodAutoscaler</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> my-app-hpa</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">scaleTargetRef</span><span class="kw">:</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> my-app</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minReplicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">maxReplicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">metrics</span><span class="kw">:</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Pods</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">pods</span><span class="kw">:</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">metric</span><span class="kw">:</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> http_requests</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">target</span><span class="kw">:</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> AverageValue</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">averageValue</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span></span></code></pre></div></li>
<li><p><strong>Apply the HPA Configuration</strong>: We need to run this
command to apply our HPA setup:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> hpa.yaml</span></code></pre></div></li>
<li><p><strong>Monitor HPA Status</strong>: We can use this command to
check the status of our HPA:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get hpa my-app-hpa</span></code></pre></div></li>
</ol>
<p>By following these steps, we can use custom metrics for HPA
autoscaling metrics in Kubernetes. This way, our application can scale
based on the workload needs. For more details on Kubernetes and
autoscaling, we can check <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-autosale-my-applications-with-horizontal-pod-autoscaler-hpa.html">this
article on using HPA</a>.</p>
<h2
id="what-are-the-steps-to-enable-kubeapi-server-flags-for-hpa-autoscaling-metrics-in-kubernetes">What
Are the Steps to Enable KubeAPI Server Flags for HPA Autoscaling Metrics
in Kubernetes?</h2>
<p>To turn on the KubeAPI Server flags we need for Horizontal Pod
Autoscaler (HPA) autoscaling metrics in Kubernetes, we can follow these
steps:</p>
<ol type="1">
<li><p><strong>Locate the KubeAPI Server Configuration</strong>: We
usually find this in the deployment manifest for the KubeAPI server. It
is often in the <code>/etc/kubernetes/manifests</code> folder on the
control plane node.</p></li>
<li><p><strong>Edit the KubeAPI Server Manifest</strong>: We need to
open the KubeAPI server manifest file. This file might be named
<code>kube-apiserver.yaml</code>.</p></li>
<li><p><strong>Add Required Flags</strong>: We should add these flags to
the <code>command</code> part of the KubeAPI server spec to enable
metrics:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> --enable-admission-plugins=...,HorizontalPodAutoscaler</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> --feature-gates=HorizontalPodAutoscaler=true</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> --request-timeout=30s</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> --enable-metrics=true</span></span></code></pre></div>
<p>Make sure we enable the needed admission plugins and features for
HPA.</p></li>
<li><p><strong>Restart the KubeAPI Server</strong>: After we save the
changes, we must restart the KubeAPI server to use the new settings. If
we use a static pod, it will usually restart by itself. For a
deployment, we can use:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> rollout restart deployment kube-apiserver <span class="at">-n</span> kube-system</span></code></pre></div></li>
<li><p><strong>Verify the Configuration</strong>: We need to check the
logs of the KubeAPI server to see if the flags were added correctly. We
can do this with:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> logs <span class="op">&lt;</span>kube-apiserver-pod-name<span class="op">&gt;</span> -n kube-system</span></code></pre></div>
<p>We should look for any errors about the HPA and confirm that the
metrics API is working.</p></li>
</ol>
<p>By following these steps, we will enable the KubeAPI Server flags for
HPA autoscaling metrics in our Kubernetes cluster. This allows the
cluster to scale dynamically based on resource use metrics. For more
information, check <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-use-horizontal-pod-autoscaler-hpa-to-scale-my-application.html">How
Do I Use Horizontal Pod Autoscaler (HPA) to Scale My
Application?</a>.</p>
<h2
id="how-do-we-verify-hpa-functionality-with-kubeapi-server-for-autoscaling-metrics-in-kubernetes">How
Do We Verify HPA Functionality with KubeAPI Server for Autoscaling
Metrics in Kubernetes?</h2>
<p>To verify the Horizontal Pod Autoscaler (HPA) works with KubeAPI
Server for autoscaling metrics in Kubernetes, we can follow these
steps:</p>
<ol type="1">
<li><p><strong>Check HPA Status:</strong> We use this command to check
the status of our HPA resource. This shows us the current metrics and
scaling actions.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get hpa</span></code></pre></div></li>
<li><p><strong>Describe HPA:</strong> To get more info about the HPA,
like the number of replicas and metrics details, we can use:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> describe hpa <span class="op">&lt;</span>hpa-name<span class="op">&gt;</span></span></code></pre></div></li>
<li><p><strong>View Metrics:</strong> We need to make sure the metrics
server is running and collecting metrics. We can check the logs of the
metrics server with:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> logs <span class="at">-n</span> kube-system <span class="at">-l</span> k8s-app=metrics-server</span></code></pre></div></li>
<li><p><strong>Check Pod Resource Usage:</strong> To confirm that the
metrics show the real usage of the pods, we use this command:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> top pods</span></code></pre></div></li>
<li><p><strong>Trigger Scaling Events:</strong> We can create load on
our application to trigger HPA scaling. We can use tools like
<code>kubectl run</code> with a load generator or a benchmarking tool
like Apache JMeter or locust.</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> run <span class="at">-i</span> <span class="at">--tty</span> load-generator <span class="at">--image</span><span class="op">=</span>busybox /bin/sh</span></code></pre></div>
<p>Inside the pod, we can generate load using:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="fu">true</span><span class="kw">;</span> <span class="cf">do</span> <span class="fu">wget</span> <span class="at">-q</span> <span class="at">-O-</span> http://<span class="op">&lt;</span>service-name<span class="op">&gt;</span><span class="kw">;</span> <span class="cf">done</span></span></code></pre></div></li>
<li><p><strong>Monitor Scaling Events:</strong> We can watch the HPA
resource to see if it scales up or down based on the load we
created:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">watch</span> kubectl get hpa</span></code></pre></div></li>
<li><p><strong>Verify Pod Scaling:</strong> We check the number of pods
running for our deployment after we trigger scaling:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get deployment <span class="op">&lt;</span>deployment-name<span class="op">&gt;</span></span></code></pre></div></li>
<li><p><strong>Examine Events:</strong> We can also check for events
about the HPA to see if there were problems with scaling:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get events <span class="at">--sort-by</span><span class="op">=</span><span class="st">&#39;.metadata.creationTimestamp&#39;</span></span></code></pre></div></li>
</ol>
<p>These steps help us to confirm that the HPA works well with the
KubeAPI Server for autoscaling metrics in Kubernetes. For more details
and info about HPA, we can refer to <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-use-horizontal-pod-autoscaler-hpa-to-scale-my-application.html">this
guide on using Horizontal Pod Autoscaler</a>.</p>
<h2 id="frequently-asked-questions">Frequently Asked Questions</h2>
<h3
id="what-is-the-purpose-of-enabling-kubeapi-server-for-hpa-autoscaling-metrics-in-kubernetes">1.
What is the purpose of enabling KubeAPI Server for HPA Autoscaling
Metrics in Kubernetes?</h3>
<p>We enable the KubeAPI Server for Horizontal Pod Autoscaler (HPA)
metrics in Kubernetes so our cluster can scale applications
automatically. This happens based on real-time CPU and memory usage. By
setting up the KubeAPI Server, we can use these metrics. This helps our
applications meet demand without needing us to do it manually. It also
makes our resources work better and improves application
performance.</p>
<h3
id="what-prerequisites-do-i-need-to-configure-hpa-with-kubeapi-server-in-kubernetes">2.
What prerequisites do I need to configure HPA with KubeAPI Server in
Kubernetes?</h3>
<p>To set up HPA with KubeAPI Server for autoscaling metrics, we need a
running Kubernetes cluster. The Metrics Server must be installed too.
Also, we must make sure our cluster runs a compatible version of
Kubernetes which is 1.6 or later. Our service accounts should have the
right permissions to access metrics. It helps if we know about
Kubernetes configuration files and kubectl commands.</p>
<h3
id="how-do-i-verify-that-the-hpa-is-working-correctly-with-kubeapi-server-metrics">3.
How do I verify that the HPA is working correctly with KubeAPI Server
metrics?</h3>
<p>We can check if HPA works well with KubeAPI Server for autoscaling
metrics by using the <code>kubectl get hpa</code> command. This command
shows the status of HPA objects. We should also look at the logs of the
Metric Server and our pods. This helps us see if metrics are collected
and reported correctly. The right metrics should show the desired state
of our applications. They should trigger scaling events as we
expect.</p>
<h3 id="can-i-use-custom-metrics-with-hpa-in-kubernetes">4. Can I use
custom metrics with HPA in Kubernetes?</h3>
<p>Yes, we can use custom metrics with Horizontal Pod Autoscaler (HPA)
in Kubernetes. By setting up the Metrics API and using a custom metrics
adapter, we can show application-specific metrics to the KubeAPI Server.
This allows HPA to scale our applications based on metrics that are more
than just CPU and memory. It helps us meet the unique needs of our
application.</p>
<h3
id="how-do-i-configure-the-metrics-server-for-hpa-autoscaling-metrics-in-kubernetes">5.
How do I configure the Metrics Server for HPA Autoscaling Metrics in
Kubernetes?</h3>
<p>To set up the Metrics Server for HPA autoscaling metrics in
Kubernetes, we deploy the Metrics Server using the official YAML file.
We must check that it works well with our Kubernetes cluster. We do this
by making sure it can collect metrics from our nodes and pods. After we
set it up, HPA will get metrics from the Metrics Server. This helps with
automatic scaling based on how much resources we use.</p>
<p>For more reading on Kubernetes and its parts, we can check articles
like <a
href="https://bestonlinetutorial.com/kubernetes/what-are-the-key-components-of-a-kubernetes-cluster.html">What
are the key components of a Kubernetes cluster?</a> and <a
href="https://bestonlinetutorial.com/kubernetes/how-do-i-use-horizontal-pod-autoscaler-hpa-to-scale-my-application.html">How
do I use Horizontal Pod Autoscaler (HPA) to scale my
application?</a>.</p>

                        </div>

                    </div>
                    <!--//container-->
                </article>

            </div>
            <!--//main-wrapper-->

            <div id="footer-placeholder"></div>

            <!-- Javascript -->
            <script src="/assets/plugins/popper.min.js" defer></script>
            <script src="/assets/plugins/bootstrap/js/bootstrap.min.js" defer></script>
            <script src="/assets/fontawesome/js/all.min.js" defer></script>
        </body>

        </html>
            
            