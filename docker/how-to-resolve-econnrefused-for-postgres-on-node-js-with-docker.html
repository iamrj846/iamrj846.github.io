
    
            <!DOCTYPE html>
        <html lang="en">

        <head>
            <!-- Google tag (gtag.js) -->
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-TFCQEJR7TD"></script>
            <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-TFCQEJR7TD');
            </script>
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <!-- Common CSS & Icons -->
            <link rel="icon" href="/favicon.ico" type="image/x-icon">
            <link rel="stylesheet" href="/assets/plugins/highlight/styles/monokai-sublime.css">
            <link id="theme-style" rel="stylesheet" href="/assets/css/theme-8.css">
            <link rel="stylesheet" href="/assets/css/post.css">
            <title>How to Resolve ECONNREFUSED for Postgres on Node.js with Docker?</title>
            <meta name="description" content="Learn how to fix ECONNREFUSED errors for Postgres in Node.js using Docker. Step-by-step solutions to troubleshoot your setup.">
            <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	        <script src="/assets/js/blog.js"></script>
        </head>

        <body>

            <div id="header-placeholder"></div>

            <div class="main-wrapper">

                <article class="blog-post px-3 py-5 p-md-5">
                    <div class="container single-col-max-width">
                        <header class="blog-post-header">
                            <h1 class="title mb-2">How to Resolve ECONNREFUSED for Postgres on Node.js with Docker?</h1>
                        </header>

                        <div class="blog-post-body">
                            <p>To fix the ECONNREFUSED error when we connect to a PostgreSQL
database from a Node.js app running in Docker, we need to make sure our
Node.js service is set up right. This means we should check if the
PostgreSQL container is running. We also need to look at the connection
string to make sure it is correct. Finally, we must confirm that the
networking settings between the two containers are correct. Following
these steps will help us troubleshoot and fix the ECONNREFUSED error in
our Docker app.</p>
<p>In this article, we will look at a simple guide to fix the
ECONNREFUSED error when we use PostgreSQL with Node.js in Docker. We
will talk about these topics to help us solve the issue:</p>
<ul>
<li>What is the ECONNREFUSED Error in Node.js with Docker</li>
<li>How to Check Postgres Container Status in Docker</li>
<li>How to Configure Docker Networking for Postgres and Node.js</li>
<li>How to Verify Connection Parameters for Postgres in Node.js</li>
<li>How to Set Up Health Checks for Postgres in Docker</li>
<li>Frequently Asked Questions</li>
</ul>
<p>By looking at these areas, we will be ready to handle the common
problems that cause connection refusals in our setup.</p>
<h2 id="how-to-fix-econnrefused-for-postgres-on-node.js-with-docker">How
to Fix ECONNREFUSED for Postgres on Node.js with Docker</h2>
<h2
id="understanding-the-econnrefused-error-in-node.js-with-docker">Understanding
the ECONNREFUSED Error in Node.js with Docker</h2>
<p>The <code>ECONNREFUSED</code> error in Node.js happens when we try to
connect to a server that does not accept connections. This is common
when we work with Docker applications. The way networks and containers
are set up can affect our ability to connect. The error usually
means:</p>
<ul>
<li>The Postgres container is not running.</li>
<li>The connection details (host, port, username, password) are
wrong.</li>
<li>The Postgres server does not allow connections from the Node.js
app.</li>
</ul>
<p>To fix it, we should make sure the Postgres container is running and
reachable. We also need to check the connection details in our Node.js
app.</p>
<h3 id="example-error-message">Example Error Message</h3>
<pre class="plaintext"><code>Error: connect ECONNREFUSED 127.0.0.1:5432</code></pre>
<p>To fix this, we might need to check different settings like the
container status, networking, and connection details.</p>
<p>For more information about Docker networking, we can look at <a
href="https://bestonlinetutorial.com/docker/what-are-docker-networks-and-why-are-they-necessary.html">what
are Docker networks and why are they necessary</a>.</p>
<h2 id="checking-postgres-container-status-in-docker">Checking Postgres
Container Status in Docker</h2>
<p>To fix the <code>ECONNREFUSED</code> error when we connect to a
Postgres database from a Node.js app running in Docker, we need to check
the status of our Postgres container. We can use the Docker CLI for
this.</p>
<ol type="1">
<li><p><strong>List Running Containers</strong>: First, we use this
command to see all running containers. This helps us check if our
Postgres container is active.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> ps</span></code></pre></div>
<p>We look for our Postgres container in the output. If we do not see
it, it may not be running.</p></li>
<li><p><strong>Check Container Logs</strong>: If the container is
running but we still have connection problems, we should check the logs
for any errors. We can use this command:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> logs <span class="op">&lt;</span>container_name_or_id<span class="op">&gt;</span></span></code></pre></div>
<p>We need to replace <code>&lt;container_name_or_id&gt;</code> with the
actual name or ID of our Postgres container. We look for errors related
to startup or authentication.</p></li>
<li><p><strong>Inspect the Container</strong>: To get more details about
the container’s setup and state, we can use:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> inspect <span class="op">&lt;</span>container_name_or_id<span class="op">&gt;</span></span></code></pre></div>
<p>This command gives us detailed info, including network settings. This
can help us find connection issues.</p></li>
<li><p><strong>Check Health Status</strong>: If we set up health checks
in our Docker setup, we can check the health status of our Postgres
container.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> inspect <span class="at">--format</span><span class="op">=</span><span class="st">&#39;{{json .State.Health}}&#39;</span> <span class="op">&lt;</span>container_name_or_id<span class="op">&gt;</span></span></code></pre></div>
<p>We need to make sure the health status is <code>healthy</code>. If
not, we may need to troubleshoot the Postgres startup or setup.</p></li>
<li><p><strong>Restarting the Container</strong>: If everything looks
fine but we still get connection refused, we can try restarting the
Postgres container:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> restart <span class="op">&lt;</span>container_name_or_id<span class="op">&gt;</span></span></code></pre></div></li>
<li><p><strong>Network Configuration</strong>: We should check if our
Node.js app and Postgres container are on the same Docker network. We
can check the networks with:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> network ls</span></code></pre></div>
<p>If they are not on the same network, we may need to create a new
network or connect the containers to one that exists.</p></li>
</ol>
<p>By following these steps, we can check the status of our Postgres
container and solve problems that cause the <code>ECONNREFUSED</code>
error when we connect from our Node.js app. If we need more help with
Docker setups, we can check articles on <a
href="https://bestonlinetutorial.com/docker/how-does-docker-networking-work-for-multi-container-applications.html">Docker
networking</a> and <a
href="https://bestonlinetutorial.com/docker/how-to-check-the-health-status-of-a-docker-container.html">Docker
container health checks</a>.</p>
<h2
id="configuring-docker-networking-for-postgres-and-node.js">Configuring
Docker Networking for Postgres and Node.js</h2>
<p>To fix the <code>ECONNREFUSED</code> error when we connect Node.js to
Postgres in Docker, we need to set up networking right. We can use
Docker’s bridge networking or make a custom network for better control
and separation. Here are the steps to set up Docker networking well.</p>
<ol type="1">
<li><p><strong>Create a Custom Docker Network</strong>:<br />
This helps containers talk to each other by name.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> network create my-network</span></code></pre></div></li>
<li><p><strong>Run Postgres Container</strong>:<br />
When we start the Postgres container, we must connect it to the custom
network.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--name</span> my-postgres <span class="at">--network</span> my-network <span class="at">-e</span> POSTGRES_USER=myuser <span class="at">-e</span> POSTGRES_PASSWORD=mypassword <span class="at">-d</span> postgres</span></code></pre></div></li>
<li><p><strong>Run Node.js Container</strong>:<br />
Next, we run the Node.js app container on the same network.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--name</span> my-node-app <span class="at">--network</span> my-network <span class="at">-p</span> 3000:3000 <span class="at">-d</span> my-node-image</span></code></pre></div></li>
<li><p><strong>Connect to Postgres</strong>:<br />
In our Node.js app, we need to connect to the Postgres container using
its name.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { Client } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;pg&#39;</span>)<span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">Client</span>({</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">host</span><span class="op">:</span> <span class="st">&#39;my-postgres&#39;</span><span class="op">,</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">user</span><span class="op">:</span> <span class="st">&#39;myuser&#39;</span><span class="op">,</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;mypassword&#39;</span><span class="op">,</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">database</span><span class="op">:</span> <span class="st">&#39;mydatabase&#39;</span><span class="op">,</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">port</span><span class="op">:</span> <span class="dv">5432</span><span class="op">,</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">connect</span>()</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Connected to Postgres&#39;</span>))</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">catch</span>(err <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Connection error&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">stack</span>))<span class="op">;</span></span></code></pre></div></li>
<li><p><strong>Verify Network Configuration</strong>:<br />
We can check the network setup and see if both containers are in the
same network.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> network inspect my-network</span></code></pre></div></li>
</ol>
<p>By doing these steps, we can avoid <code>ECONNREFUSED</code> errors.
This way, our Node.js app will find the Postgres service name and
connect well. For more details on Docker networking, check <a
href="https://bestonlinetutorial.com/docker/what-are-docker-networks-and-why-are-they-necessary.html">this
article on Docker networks</a>.</p>
<h2
id="verifying-connection-parameters-for-postgres-in-node.js">Verifying
Connection Parameters for Postgres in Node.js</h2>
<p>To connect to a Postgres database from a Node.js app in Docker, we
need to check the connection parameters. Here is how we can make sure
our setup is correct.</p>
<ol type="1">
<li><p><strong>Database Connection String</strong>: We need to check if
our connection string is correct. The usual format looks like this:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { Client } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;pg&#39;</span>)<span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">Client</span>({</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">user</span><span class="op">:</span> <span class="st">&#39;your_username&#39;</span><span class="op">,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">host</span><span class="op">:</span> <span class="st">&#39;your_postgres_container_name_or_ip&#39;</span><span class="op">,</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">database</span><span class="op">:</span> <span class="st">&#39;your_database&#39;</span><span class="op">,</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;your_password&#39;</span><span class="op">,</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">port</span><span class="op">:</span> <span class="dv">5432</span><span class="op">,</span> <span class="co">// Default Postgres port</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">connect</span>(err <span class="kw">=&gt;</span> {</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (err) {</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Connection error&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">stack</span>)<span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Connected to Postgres&#39;</span>)<span class="op">;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div></li>
<li><p><strong>Environment Variables</strong>: We should use environment
variables to keep sensitive info and settings. We can update our
Dockerfile or <code>docker-compose.yml</code> to set these
variables.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;3.8&#39;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">postgres</span><span class="kw">:</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:latest</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_USER</span><span class="kw">:</span><span class="at"> your_username</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_PASSWORD</span><span class="kw">:</span><span class="at"> your_password</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_DB</span><span class="kw">:</span><span class="at"> your_database</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">app</span><span class="kw">:</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DB_USER</span><span class="kw">:</span><span class="at"> your_username</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DB_PASSWORD</span><span class="kw">:</span><span class="at"> your_password</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DB_HOST</span><span class="kw">:</span><span class="at"> postgres</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DB_PORT</span><span class="kw">:</span><span class="at"> </span><span class="dv">5432</span></span></code></pre></div></li>
<li><p><strong>Docker Networking</strong>: We must make sure our Node.js
app can talk to the Postgres container. They should be on the same
Docker network. If we use Docker Compose, it creates a network for
us.</p></li>
<li><p><strong>Health Check</strong>: We should add health checks for
the Postgres container. This helps to ensure it is ready for connections
before our Node.js app connects.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">postgres</span><span class="kw">:</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:latest</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">healthcheck</span><span class="kw">:</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">test</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;CMD&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;pg_isready&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;-U&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;your_username&quot;</span><span class="kw">]</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">interval</span><span class="kw">:</span><span class="at"> 10s</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> 5s</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">retries</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span></code></pre></div></li>
<li><p><strong>Error Handling</strong>: We need to add good error
handling in our Node.js app. This helps us catch connection problems. It
also helps us fix issues quickly.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">connect</span>()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Connected to Postgres&#39;</span>))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">catch</span>(err <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Connection error&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">stack</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">finally</span>(() <span class="kw">=&gt;</span> client<span class="op">.</span><span class="fu">end</span>())<span class="op">;</span></span></code></pre></div></li>
</ol>
<p>By checking these connection parameters and settings, we can fix
common problems when using Postgres in a Node.js app inside Docker. For
more info on containerization and Docker, check out <a
href="https://bestonlinetutorial.com/docker/what-is-containerization-and-how-does-it-relate-to-docker.html">this
article</a>.</p>
<h2 id="setting-up-health-checks-for-postgres-in-docker">Setting Up
Health Checks for Postgres in Docker</h2>
<p>We can set up health checks for a Postgres container in Docker. This
helps to make sure the database is working well and can be reached by
our Node.js application. We can define health checks in the Dockerfile
or in the Docker Compose file. Here’s how we can do it for a Postgres
service.</p>
<h3 id="using-docker-compose">Using Docker Compose</h3>
<p>In our <code>docker-compose.yml</code>, we can add health checks
under the Postgres service like this:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;3.8&#39;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">postgres</span><span class="kw">:</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:latest</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_USER</span><span class="kw">:</span><span class="at"> your_username</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_PASSWORD</span><span class="kw">:</span><span class="at"> your_password</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_DB</span><span class="kw">:</span><span class="at"> your_database</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;5432:5432&quot;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">healthcheck</span><span class="kw">:</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">test</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;CMD-SHELL&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;pg_isready -U your_username&quot;</span><span class="kw">]</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">interval</span><span class="kw">:</span><span class="at"> 10s</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> 5s</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">retries</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span></code></pre></div>
<h3 id="explanation-of-health-check-parameters">Explanation of Health
Check Parameters</h3>
<ul>
<li><strong>test</strong>: This command checks if Postgres can accept
connections. The <code>pg_isready</code> tool checks the connection to
the Postgres server.</li>
<li><strong>interval</strong>: This is the time between health checks,
which is 10 seconds in our example.</li>
<li><strong>timeout</strong>: This is the time we wait for a health
check to succeed, here it is 5 seconds.</li>
<li><strong>retries</strong>: This is how many failures we need to see
before we say the container is unhealthy. In this case, it is 3
retries.</li>
</ul>
<h3 id="running-health-checks">Running Health Checks</h3>
<p>To run the health checks, we can use this command to start our Docker
Compose services:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker-compose</span> up</span></code></pre></div>
<p>We can check the health status of our Postgres container using:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> inspect <span class="at">--format</span><span class="op">=</span><span class="st">&#39;{{json .State.Health}}&#39;</span> <span class="op">&lt;</span>container_id<span class="op">&gt;</span></span></code></pre></div>
<p>This command gives us detailed health check info. It tells us if the
container is healthy or not.</p>
<p>Adding health checks to our Docker setup for Postgres helps us avoid
connection errors like ECONNREFUSED in our Node.js application. It makes
sure the database is ready before our app tries to connect.</p>
<h2 id="frequently-asked-questions">Frequently Asked Questions</h2>
<h3 id="what-causes-the-econnrefused-error-in-node.js-with-docker">What
causes the ECONNREFUSED error in Node.js with Docker?</h3>
<p>The ECONNREFUSED error in Node.js with Docker happens when our
application cannot connect to the Postgres database. There are many
reasons for this. The Postgres container might not be running. Sometimes
the connection details can be wrong or there might be network issues
between the containers. To fix this, we should check that the Postgres
container is running and that the Node.js app has the right connection
details.</p>
<h3
id="how-can-i-check-if-my-postgres-container-is-running-in-docker">How
can I check if my Postgres container is running in Docker?</h3>
<p>To see if our Postgres container is running in Docker, we can use
this command in the terminal:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> ps</span></code></pre></div>
<p>This command shows all running containers. We need to look for our
Postgres container in the list. If we do not see it, we may need to
start it with <code>docker start &lt;container_name&gt;</code> or check
the logs with <code>docker logs &lt;container_name&gt;</code> to find
any problems with starting it.</p>
<h3
id="what-are-the-best-practices-for-configuring-docker-networking-between-node.js-and-postgres">What
are the best practices for configuring Docker networking between Node.js
and Postgres?</h3>
<p>When we set up Docker networking for our Node.js app and Postgres
database, we should use a user-defined bridge network. This lets
containers talk to each other using their service names as hostnames. We
also need to make sure the ports are open and that the Node.js app uses
the right connection string, like
<code>postgres://user:password@postgres_container:5432/dbname</code>.
Here, <code>postgres_container</code> is the name of our Postgres
service.</p>
<h3
id="how-can-i-verify-connection-parameters-for-postgres-in-my-node.js-application">How
can I verify connection parameters for Postgres in my Node.js
application?</h3>
<p>To check our connection parameters for Postgres in the Node.js app,
we need to look at these details: the database host (which is usually
the Postgres container name), the port (default is 5432), the database
name, username, and password. We must ensure these match what we set in
our Postgres container. We can test the connection using a simple script
or a database client to make sure the parameters are correct.</p>
<h3
id="how-do-i-set-up-health-checks-for-my-postgres-container-in-docker">How
do I set up health checks for my Postgres container in Docker?</h3>
<p>To set up health checks for our Postgres container in Docker, we need
to add a health check command in our Dockerfile or docker-compose.yml
file. For example, we can add this in our
<code>docker-compose.yml</code>:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">healthcheck</span><span class="kw">:</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;CMD&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;pg_isready&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;-U&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;your_username&quot;</span><span class="kw">]</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">interval</span><span class="kw">:</span><span class="at"> 30s</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> 10s</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">retries</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span></code></pre></div>
<p>This command checks if Postgres is ready to accept connections.
Health checks help us ensure that our Node.js app only tries to connect
when the Postgres database is fully ready. This way, we can avoid
ECONNREFUSED errors.</p>
<p>For more tips on using Docker for database apps, check out <a
href="https://bestonlinetutorial.com/docker/how-to-connect-docker-containers-to-different-networks.html">how
to connect Docker containers to different networks</a>.</p>

                        </div>

                    </div>
                    <!--//container-->
                </article>

            </div>
            <!--//main-wrapper-->

            <div id="footer-placeholder"></div>

            <!-- Javascript -->
            <script src="/assets/plugins/popper.min.js" defer></script>
            <script src="/assets/plugins/bootstrap/js/bootstrap.min.js" defer></script>
            <script src="/assets/fontawesome/js/all.min.js" defer></script>
        </body>

        </html>
            
            