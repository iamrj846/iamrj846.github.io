
    
            <!DOCTYPE html>
        <html lang="en">

        <head>
            <!-- Google tag (gtag.js) -->
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-TFCQEJR7TD"></script>
            <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-TFCQEJR7TD');
            </script>
            
            <title>How do I write and execute Lua scripts in Redis?</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Common CSS & Icons -->
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/assets/plugins/highlight/styles/monokai-sublime.css">
<link id="theme-style" rel="stylesheet" href="/assets/css/theme-8.css">
<link rel="stylesheet" href="/assets/css/post.css">
            <meta name="description" content="Learn how to write and execute Lua scripts in Redis for enhanced data manipulation and performance. Boost your Redis skills today!">
            <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	        <script src="/assets/js/blog.js"></script>
        </head>

        <body>

            <div id="header-placeholder"></div>

            <div class="main-wrapper">

                <article class="blog-post px-3 py-5 p-md-5">
                    <div class="container single-col-max-width">
                        <header class="blog-post-header">
                            <h1 class="title mb-2">How do I write and execute Lua scripts in Redis?</h1>
                        </header>

                        <div class="blog-post-body">
                            <p><strong>Lua Scripting in Redis: A Simple Guide</strong></p>
<p>Lua scripting in Redis lets us run complex tasks right on the data in
Redis. This helps improve speed and features. With Lua, we can make
scripts that run all at once. This means we can safely run many commands
without problems from other tasks happening at the same time.</p>
<p>In this article, we will learn the basics of writing and running Lua
scripts in Redis. We will talk about many things. First, we will
introduce Lua scripting in Redis. Then, we will look at its benefits.
After that, we will create a simple Lua script. Next, we will load and
run scripts. We will also share some practical examples. We will give
tips for writing good scripts. Finally, we will answer common questions.
The sections below will help us step by step:</p>
<ul>
<li>How to Write and Execute Lua Scripts in Redis?</li>
<li>What is Lua Scripting in Redis?</li>
<li>Why Use Lua Scripts in Redis?</li>
<li>How to Create a Simple Lua Script for Redis?</li>
<li>How to Load and Execute Lua Scripts in Redis?</li>
<li>Practical Examples of Lua Scripts in Redis</li>
<li>Best Practices for Writing Lua Scripts in Redis</li>
<li>Frequently Asked Questions</li>
</ul>
<p>For more reading about Redis and its features, we can check out
articles like <a
href="https://bestonlinetutorial.com/redis/what-is-redis.html">What is
Redis?</a> and <a
href="https://bestonlinetutorial.com/redis/how-do-i-use-redis-lua-scripting.html">How
do I use Redis Lua Scripting?</a>.</p>
<h2 id="what-is-lua-scripting-in-redis">What is Lua Scripting in
Redis?</h2>
<p>Lua scripting in Redis helps us run scripts that we write in the Lua
programming language right on the Redis server. This is useful because
it allows us to do all commands in the script at once. It means no other
clients can interfere while we run our script.</p>
<h3 id="key-features-of-lua-scripting-in-redis">Key Features of Lua
Scripting in Redis:</h3>
<ul>
<li><strong>Atomicity</strong>: Our scripts run alone. This keeps
everything consistent and avoids problems from multiple actions
happening at the same time.</li>
<li><strong>Performance</strong>: It cuts down the number of trips
between the client and server. This makes things faster.</li>
<li><strong>Built-in Functions</strong>: Lua scripts can use Redis
commands. This lets us run complex logic on the server.</li>
</ul>
<h3 id="how-to-use-lua-scripting">How to Use Lua Scripting:</h3>
<ul>
<li>We can run scripts using the <code>EVAL</code> command. This command
takes the script code, how many keys it will use, and the keys as
inputs.</li>
</ul>
<h3 id="example">Example:</h3>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">EVAL</span> <span class="st">&quot;return redis.call(&#39;GET&#39;, KEYS[1])&quot;</span> 1 mykey</span></code></pre></div>
<p>This command gets the value of <code>mykey</code> and shows it as the
output of the script.</p>
<p>If we want to learn more about the benefits and features of Lua
scripting in Redis, we can check <a
href="https://bestonlinetutorial.com/redis/what-are-the-benefits-of-lua-scripting-in-redis.html">what
are the benefits of Lua scripting in Redis</a>.</p>
<h2 id="why-use-lua-scripts-in-redis">Why Use Lua Scripts in Redis?</h2>
<p>We can see that Lua scripting in Redis gives us many benefits. It
helps make our database operations work better and faster. Here are the
main reasons to use Lua scripts in Redis:</p>
<ul>
<li><p><strong>Atomic Operations</strong>: Lua scripts let us run a
group of commands all at once. This means no other commands can get in
the way. It is very important for keeping our data safe and correct when
we do complex tasks.</p></li>
<li><p><strong>Reduced Round Trips</strong>: When we run many commands
in one Lua script, we cut down on how often we have to send requests
between our app and the Redis server. This can help our performance a
lot, especially when there is a delay in the network.</p></li>
<li><p><strong>Complex Logic</strong>: With Lua, we can add complex
business rules directly on the server. We can do calculations and change
data without moving it back and forth between the client and
server.</p></li>
<li><p><strong>Improved Performance</strong>: Lua scripts run inside the
Redis process. This means we don’t have to worry about the extra time it
takes for network communication. It makes things faster, especially for
tasks that need many Redis commands.</p></li>
<li><p><strong>Custom Functions</strong>: We can create our own
functions to fit our needs. Then we can run them right in Redis. This
gives us more options than just the built-in Redis commands.</p></li>
<li><p><strong>Data Integrity</strong>: Using Lua scripts helps us make
sure important tasks happen without interruptions from other clients.
This keeps our data safe and sound.</p></li>
<li><p><strong>Ease of Use</strong>: Lua is easy to learn. Its simple
syntax helps us write short scripts for working with Redis.</p></li>
</ul>
<p>Here’s a simple Lua script that increases a value in Redis:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">current</span> <span class="op">=</span> <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;GET&#39;</span><span class="op">,</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="va">current</span> <span class="cf">then</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">nil</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">new_value</span> <span class="op">=</span> <span class="fu">tonumber</span><span class="op">(</span><span class="va">current</span><span class="op">)</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;SET&#39;</span><span class="op">,</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="va">new_value</span><span class="op">)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="va">new_value</span></span></code></pre></div>
<p>This script gets a value, adds one to it, and saves it back in Redis.
It shows how Lua scripting can help us do tasks in a smart way.</p>
<p>If we want to learn more about how to use Lua scripting well, we can
read more about the benefits of Lua scripting in Redis <a
href="https://bestonlinetutorial.com/redis/what-are-the-benefits-of-lua-scripting-in-redis.html">here</a>.</p>
<h2 id="how-to-create-a-simple-lua-script-for-redis">How to Create a
Simple Lua Script for Redis?</h2>
<p>We can create a simple Lua script for Redis by writing the script in
Lua and running it in the Redis environment. Lua scripts help us do
atomic operations and manage data. We can also run many commands at
once.</p>
<h3 id="example-of-a-simple-lua-script">Example of a Simple Lua
Script</h3>
<p>Here is a basic Lua script that increases a value stored in
Redis:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Lua Script to increment a value</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">current_value</span> <span class="op">=</span> <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&quot;GET&quot;</span><span class="op">,</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="va">current_value</span> <span class="cf">then</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">current_value</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">incremented_value</span> <span class="op">=</span> <span class="fu">tonumber</span><span class="op">(</span><span class="va">current_value</span><span class="op">)</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&quot;SET&quot;</span><span class="op">,</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="va">incremented_value</span><span class="op">)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="va">incremented_value</span></span></code></pre></div>
<h3 id="breakdown-of-the-script">Breakdown of the Script</h3>
<ul>
<li><code>KEYS[1]</code>: This is the first key we give to the script
when we run it.</li>
<li><code>redis.call("GET", KEYS[1])</code>: This gets the current value
for the key.</li>
<li><code>tonumber(current_value) + 1</code>: This changes the current
value to a number and adds one.</li>
<li><code>redis.call("SET", KEYS[1], incremented_value)</code>: This
saves the new value back to the key.</li>
<li><code>return incremented_value</code>: This sends back the new
value.</li>
</ul>
<h3 id="saving-the-script">Saving the Script</h3>
<p>We can save the Lua script above in a <code>.lua</code> file. For
example, we can name it <code>increment.lua</code>.</p>
<h3 id="executing-the-lua-script-in-redis">Executing the Lua Script in
Redis</h3>
<p>To run the Lua script in Redis, we use the <code>EVAL</code> command.
We need to specify the script, how many keys we use, and the key(s):</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">EVAL</span> <span class="st">&quot;return redis.call(&#39;SET&#39;, KEYS[1], tonumber(redis.call(&#39;GET&#39;, KEYS[1]) or 0) + 1)&quot;</span> 1 mykey</span></code></pre></div>
<p>In this command: - We pass the script as a string. - <code>1</code>
shows that we are using one key. - <code>mykey</code> is the key we want
to increase.</p>
<h3 id="loading-scripts-into-redis">Loading Scripts into Redis</h3>
<p>We can also load the script into Redis with <code>SCRIPT LOAD</code>
and run it later using its SHA1 hash:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the script</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">SCRIPT</span> LOAD <span class="st">&quot;return redis.call(&#39;SET&#39;, KEYS[1], tonumber(redis.call(&#39;GET&#39;, KEYS[1]) or 0) + 1)&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute the script using the SHA1 hash returned by SCRIPT LOAD</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">EVALSHA</span> <span class="op">&lt;</span>SHA1_HASH<span class="op">&gt;</span> 1 mykey</span></code></pre></div>
<p>This way helps improve speed by letting Redis keep the script after
we load it.</p>
<p>Creating and running Lua scripts in Redis helps us do complex tasks
quickly. We can use Redis’s atomic operations and Lua’s scripting
features. For more information on Lua scripting in Redis, we can check
<a
href="https://bestonlinetutorial.com/redis/how-do-i-use-redis-lua-scripting.html">this
article</a>.</p>
<h2 id="how-to-load-and-execute-lua-scripts-in-redis">How to Load and
Execute Lua Scripts in Redis?</h2>
<p>We can load and run Lua scripts in Redis by using the
<code>EVAL</code> command or the <code>SCRIPT LOAD</code> command. Let’s
see how to do both.</p>
<h3 id="using-eval-command">Using EVAL Command</h3>
<p>The <code>EVAL</code> command lets us run Lua scripts straight away.
The format is like this:</p>
<pre class="plaintext"><code>EVAL script numkeys key1 key2 ... arg1 arg2 ...</code></pre>
<ul>
<li><code>script</code>: This is the Lua script we want to run.</li>
<li><code>numkeys</code>: This shows how many keys we send to the
script.</li>
<li><code>key1</code>, <code>key2</code>, …: These are the keys the
script will work on.</li>
<li><code>arg1</code>, <code>arg2</code>, …: These are extra arguments
for the script.</li>
</ul>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>EVAL <span class="st">&quot;return redis.call(&#39;GET&#39;, KEYS[1])&quot;</span> <span class="dv">1</span> <span class="va">mykey</span></span></code></pre></div>
<p>This script gets the value of <code>mykey</code>.</p>
<h3 id="using-script-load-command">Using SCRIPT LOAD Command</h3>
<p>If we want to load a Lua script into Redis and get back its SHA1
hash, we use the <code>SCRIPT LOAD</code> command. The format is:</p>
<pre class="plaintext"><code>SCRIPT LOAD script</code></pre>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cn">SCRIPT</span> LOAD <span class="st">&quot;return redis.call(&#39;INCR&#39;, KEYS[1])&quot;</span></span></code></pre></div>
<p>This command gives us a SHA1 hash of the script. We can use this hash
with the <code>EVALSHA</code> command.</p>
<h3 id="using-evalsha-command">Using EVALSHA Command</h3>
<p>To run a script that we loaded before, we use the
<code>EVALSHA</code> command. It takes the SHA1 hash as the first
part:</p>
<pre class="plaintext"><code>EVALSHA sha1 numkeys key1 key2 ... arg1 arg2 ...</code></pre>
<p><strong>Example:</strong></p>
<p>If we have the SHA1 hash from before:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>EVALSHA <span class="st">&quot;your_sha1_hash&quot;</span> <span class="dv">1</span> <span class="va">mykey</span></span></code></pre></div>
<p>This will increase the value of <code>mykey</code>.</p>
<h3 id="notes">Notes</h3>
<ul>
<li>Make sure Redis supports Lua scripting. This is available from Redis
2.6 and later.</li>
<li>We can catch errors by putting our Lua code in pcall.</li>
<li>Scripts run one at a time. No other commands can run when the script
is working.</li>
</ul>
<p>For more details on using Lua scripts in Redis, check <a
href="https://bestonlinetutorial.com/redis/how-do-i-use-redis-lua-scripting.html">this
article on Redis Lua scripting</a>.</p>
<h2 id="practical-examples-of-lua-scripts-in-redis">Practical Examples
of Lua Scripts in Redis</h2>
<p>We can use Lua scripting in Redis to run many commands at once. This
helps us improve speed and keep things consistent. Here are some simple
examples of Lua scripts that show different ways to use them.</p>
<h3 id="example-1-incrementing-a-value">Example 1: Incrementing a
Value</h3>
<p>This script adds a number to a value in Redis and gives back the new
value.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">key</span> <span class="op">=</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">increment</span> <span class="op">=</span> <span class="fu">tonumber</span><span class="op">(</span><span class="cn">ARGV</span><span class="op">[</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">current_value</span> <span class="op">=</span> <span class="fu">tonumber</span><span class="op">(</span><span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;GET&#39;</span><span class="op">,</span> <span class="va">key</span><span class="op">)</span> <span class="kw">or</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">new_value</span> <span class="op">=</span> <span class="va">current_value</span> <span class="op">+</span> <span class="va">increment</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;SET&#39;</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="va">new_value</span><span class="op">)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="va">new_value</span></span></code></pre></div>
<p><strong>Execution:</strong></p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">EVAL</span> <span class="st">&quot;local key = KEYS[1]; local increment = tonumber(ARGV[1]); local current_value = tonumber(redis.call(&#39;GET&#39;, key) or 0); local new_value = current_value + increment; redis.call(&#39;SET&#39;, key, new_value); return new_value&quot;</span> 1 mykey 5</span></code></pre></div>
<h3 id="example-2-conditional-set">Example 2: Conditional Set</h3>
<p>This script sets a key only if it is not already there. It helps keep
things atomic.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">key</span> <span class="op">=</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">value</span> <span class="op">=</span> <span class="cn">ARGV</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;EXISTS&#39;</span><span class="op">,</span> <span class="va">key</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">then</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;SET&#39;</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="va">value</span><span class="op">)</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p><strong>Execution:</strong></p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">EVAL</span> <span class="st">&quot;local key = KEYS[1]; local value = ARGV[1]; if redis.call(&#39;EXISTS&#39;, key) == 0 then redis.call(&#39;SET&#39;, key, value); return true else return false end&quot;</span> 1 mykey <span class="st">&quot;myvalue&quot;</span></span></code></pre></div>
<h3 id="example-3-sum-values-in-a-list">Example 3: Sum Values in a
List</h3>
<p>This script adds up all the numbers in a Redis list.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">key</span> <span class="op">=</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">sum</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">length</span> <span class="op">=</span> <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;LLEN&#39;</span><span class="op">,</span> <span class="va">key</span><span class="op">)</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="va">length</span> <span class="op">-</span> <span class="dv">1</span> <span class="cf">do</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">sum</span> <span class="op">=</span> <span class="va">sum</span> <span class="op">+</span> <span class="fu">tonumber</span><span class="op">(</span><span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;LINDEX&#39;</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="va">i</span><span class="op">))</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="va">sum</span></span></code></pre></div>
<p><strong>Execution:</strong></p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">EVAL</span> <span class="st">&quot;local key = KEYS[1]; local sum = 0; local length = redis.call(&#39;LLEN&#39;, key); for i = 0, length - 1 do sum = sum + tonumber(redis.call(&#39;LINDEX&#39;, key, i)) end; return sum&quot;</span> 1 mylist</span></code></pre></div>
<h3 id="example-4-remove-expired-keys">Example 4: Remove Expired
Keys</h3>
<p>This Lua script gets rid of keys that are expired based on their
TTL.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">keys</span> <span class="op">=</span> <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;KEYS&#39;</span><span class="op">,</span> <span class="cn">ARGV</span><span class="op">[</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="op">#</span><span class="va">keys</span> <span class="cf">do</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">ttl</span> <span class="op">=</span> <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;TTL&#39;</span><span class="op">,</span> <span class="va">keys</span><span class="op">[</span><span class="va">i</span><span class="op">])</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">ttl</span> <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">then</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;DEL&#39;</span><span class="op">,</span> <span class="va">keys</span><span class="op">[</span><span class="va">i</span><span class="op">])</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="op">#</span><span class="va">keys</span></span></code></pre></div>
<p><strong>Execution:</strong></p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">EVAL</span> <span class="st">&quot;local keys = redis.call(&#39;KEYS&#39;, ARGV[1]); for i = 1, #keys do local ttl = redis.call(&#39;TTL&#39;, keys[i]); if ttl &lt; 0 then redis.call(&#39;DEL&#39;, keys[i]) end end; return #keys&quot;</span> 0 <span class="st">&quot;mykey:*&quot;</span></span></code></pre></div>
<h3 id="example-5-counting-unique-items">Example 5: Counting Unique
Items</h3>
<p>This script counts how many unique items are in a Redis set.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">key</span> <span class="op">=</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">unique_count</span> <span class="op">=</span> <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;SCARD&#39;</span><span class="op">,</span> <span class="va">key</span><span class="op">)</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="va">unique_count</span></span></code></pre></div>
<p><strong>Execution:</strong></p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">EVAL</span> <span class="st">&quot;local key = KEYS[1]; local unique_count = redis.call(&#39;SCARD&#39;, key); return unique_count&quot;</span> 1 myset</span></code></pre></div>
<p>These examples show how flexible and powerful Lua scripting is in
Redis. We can do many complex tasks easily. For more information, we can
check out <a
href="https://bestonlinetutorial.com/redis/how-do-i-use-redis-lua-scripting.html">How
Do I Use Redis Lua Scripting?</a> and <a
href="https://bestonlinetutorial.com/redis/what-are-the-benefits-of-lua-scripting-in-redis.html">What
Are the Benefits of Lua Scripting in Redis?</a>.</p>
<h2 id="best-practices-for-writing-lua-scripts-in-redis">Best Practices
for Writing Lua Scripts in Redis</h2>
<p>When we write Lua scripts for Redis, we can follow some best
practices. These practices help us improve performance, make our code
easier to maintain, and increase reliability. Here are some important
points to think about:</p>
<ul>
<li><p><strong>Keep Scripts Short and Simple</strong>: We should write
short scripts that do specific tasks. This makes our code easier to read
and understand.</p></li>
<li><p><strong>Use Local Variables</strong>: We should use local
variables instead of global ones in our Lua scripts. This helps with
performance and makes our scripts run faster.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">key</span> <span class="op">=</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">value</span> <span class="op">=</span> <span class="cn">ARGV</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span></span></code></pre></div></li>
<li><p><strong>Error Handling</strong>: We must add error handling to
deal with unexpected situations. We can use <code>redis.log</code> to
log any errors.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&quot;EXISTS&quot;</span><span class="op">,</span> <span class="va">key</span><span class="op">)</span> <span class="cf">then</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">redis</span><span class="op">.</span>error_reply<span class="op">(</span><span class="st">&quot;Key does not exist&quot;</span><span class="op">)</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div></li>
<li><p><strong>Atomicity</strong>: Lua scripts in Redis run in an atomic
way. We need to make sure our script does not depend on outside state
and does all needed tasks inside the script.</p></li>
<li><p><strong>Avoid Loops</strong>: We should try not to use loops in
our scripts. Loops can make things slower. Instead, we can batch
operations if we can.</p></li>
<li><p><strong>Leverage Built-In Functions</strong>: We can use Redis’s
built-in commands to do our tasks directly. These commands are optimized
for better performance.</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&quot;SET&quot;</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="va">value</span><span class="op">)</span></span></code></pre></div></li>
<li><p><strong>Test Scripts</strong>: We must test our Lua scripts well
in a development environment before we use them in production. This
helps us avoid errors when they run.</p></li>
<li><p><strong>Limit Script Execution Time</strong>: We should know
about Redis’s <code>maxexecutiontime</code> setting. This setting helps
us keep long-running scripts from blocking the server.</p></li>
<li><p><strong>Use <code>EVALSHA</code> for Efficiency</strong>: We can
load our script using <code>SCRIPT LOAD</code> and run it with
<code>EVALSHA</code>. This way, we do not send the script text many
times.</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">SCRIPT</span> LOAD <span class="st">&quot;return redis.call(&#39;GET&#39;, KEYS[1])&quot;</span></span></code></pre></div></li>
<li><p><strong>Document Your Code</strong>: We should add comments in
our scripts. This helps explain complex parts and makes it easier for
others and ourselves to understand later.</p></li>
</ul>
<p>If we follow these best practices, we can write Lua scripts for Redis
that are efficient and easy to maintain. For more information about the
benefits of Lua scripting in Redis, we can read this article on <a
href="https://bestonlinetutorial.com/redis/what-are-the-benefits-of-lua-scripting-in-redis.html">the
benefits of Lua scripting in Redis</a>.</p>
<h2 id="frequently-asked-questions">Frequently Asked Questions</h2>
<h3 id="what-is-the-purpose-of-lua-scripting-in-redis">1. What is the
purpose of Lua scripting in Redis?</h3>
<p>We use Lua scripting in Redis to run complex commands directly on the
server. This helps combine several Redis commands into one operation. By
doing this, we reduce network load and make things faster. Lua scripting
makes sure that operations run alone. This stops problems like race
conditions and keeps our data consistent. You can learn more about the
benefits of Lua scripting <a
href="https://bestonlinetutorial.com/redis/what-are-the-benefits-of-lua-scripting-in-redis.html">here</a>.</p>
<h3 id="how-do-i-write-a-lua-script-for-redis">2. How do I write a Lua
script for Redis?</h3>
<p>To write a Lua script for Redis, we need to make a script that
follows Lua rules and includes Redis commands. A simple Lua script can
start with a local variable, then use commands like
<code>redis.call('SET', key, value)</code>. We can save the script in a
file or load it directly in Redis with the <code>SCRIPT LOAD</code>
command and run it using <code>EVAL</code>. If you want practical
examples, check our guide on making a simple Lua script <a
href="https://bestonlinetutorial.com/redis/how-to-create-a-simple-lua-script-for-redis.html">here</a>.</p>
<h3 id="how-can-i-execute-lua-scripts-in-redis">3. How can I execute Lua
scripts in Redis?</h3>
<p>To run Lua scripts in Redis, we can use the <code>EVAL</code>
command. This command needs two things: the script and the number of
keys it will work with. For example,
<code>EVAL "return redis.call('GET', KEYS[1])" 1 mykey</code> gets the
value of <code>mykey</code>. If we have already loaded the script, we
can use its SHA1 hash with the <code>EVALSHA</code> command. For more
steps on loading and running scripts, look at our article <a
href="https://bestonlinetutorial.com/redis/how-to-load-and-execute-lua-scripts-in-redis.html">here</a>.</p>
<h3 id="what-are-the-performance-benefits-of-using-lua-in-redis">4. What
are the performance benefits of using Lua in Redis?</h3>
<p>Using Lua in Redis helps a lot with speed. It cuts down the number of
trips between the client and the server. Scripts run atomically. This
means we can process many commands at once without waiting for the
network. This not only makes things quicker but also keeps everything
consistent when we run commands at the same time. To learn more about
why Lua scripts are good, read our detailed discussion <a
href="https://bestonlinetutorial.com/redis/what-are-the-benefits-of-lua-scripting-in-redis.html">here</a>.</p>
<h3 id="what-are-the-best-practices-for-writing-lua-scripts-in-redis">5.
What are the best practices for writing Lua scripts in Redis?</h3>
<p>When we write Lua scripts for Redis, we should keep them clear and
focused on one task. This helps with maintenance and speed. We should
avoid complicated logic that could slow down the script. Also, it is
good to handle errors well and test scripts safely before we use them.
For more best practices, check out our article on writing Lua scripts <a
href="https://bestonlinetutorial.com/redis/best-practices-for-writing-lua-scripts-in-redis.html">here</a>.</p>

                        </div>

                    </div>
                    <!--//container-->
                </article>

            </div>
            <!--//main-wrapper-->

            <div id="footer-placeholder"></div>

            <!-- Javascript -->
            <script src="/assets/plugins/popper.min.js" defer></script>
            <script src="/assets/plugins/bootstrap/js/bootstrap.min.js" defer></script>
            <script src="/assets/fontawesome/js/all.min.js" defer></script>
        </body>

        </html>
            
            