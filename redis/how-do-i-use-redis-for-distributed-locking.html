
    
            <!DOCTYPE html>
        <html lang="en">

        <head>
            <!-- Google tag (gtag.js) -->
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-TFCQEJR7TD"></script>
            <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-TFCQEJR7TD');
            </script>
            
            <title>How do I use Redis for distributed locking?</title>
            <meta name="description" content="Learn how to implement distributed locking with Redis in this comprehensive guide. Boost your app's performance and reliability!">
            <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	        <script src="/assets/js/blog.js"></script>
        </head>

        <body>

            <div id="header-placeholder"></div>

            <div class="main-wrapper">

                <article class="blog-post px-3 py-5 p-md-5">
                    <div class="container single-col-max-width">
                        <header class="blog-post-header">
                            <h1 class="title mb-2">How do I use Redis for distributed locking?</h1>
                        </header>

                        <div class="blog-post-body">
                            <p><strong>Understanding Distributed Locking with Redis</strong></p>
<p>Distributed locking is a way for multiple processes to work together.
It helps them to share resources in a distributed system. We need to
make sure that only one process can use a resource at one time. This
way, we stop conflicts and mistakes when processes try to change the
same resource. So, distributed locking is very important. It helps keep
our data safe and correct, especially when we use many servers.</p>
<p>In this article, we will look at how to use Redis for distributed
locking. We will explain its locking patterns and how it works. We will
talk about the Redlock algorithm. We will also give some easy code
examples for using distributed locking with Redis. We will explain how
to manage lock expiration and renewal. Plus, we will share some best
practices for using Redis in this way. We will also answer some common
questions.</p>
<ul>
<li>How can I implement distributed locking with Redis?</li>
<li>What is the Redis distributed locking pattern?</li>
<li>How does Redis handle locking mechanisms?</li>
<li>How do I use Redlock algorithm for distributed locking?</li>
<li>What are practical code examples for Redis distributed locking?</li>
<li>How to handle lock expiration and renewal in Redis?</li>
<li>What are the best practices for using Redis for distributed
locking?</li>
<li>Frequently Asked Questions</li>
</ul>
<h2 id="what-is-the-redis-distributed-locking-pattern">What is the Redis
distributed locking pattern?</h2>
<p>The Redis distributed locking pattern uses Redis to control locks in
different systems. This way, only one process can use a shared resource
at a time. This pattern helps to avoid race conditions and keeps data
safe when many processes run at once.</p>
<h3 id="key-components">Key Components:</h3>
<ul>
<li><strong>Lock Acquisition</strong>: A client tries to get a lock by
setting a key in Redis.</li>
<li><strong>Lock Expiration</strong>: The lock key needs an expiration
time. This helps to avoid deadlocks if the client with the lock crashes
or forgets to release it.</li>
<li><strong>Lock Release</strong>: The client must remove the lock by
deleting the key from Redis.</li>
</ul>
<h3 id="basic-implementation-steps">Basic Implementation Steps:</h3>
<ol type="1">
<li><p><strong>Acquire Lock</strong>: We can use the <code>SETNX</code>
command to set a lock key only if it doesnâ€™t already exist.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> redis.Redis()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> acquire_lock(lock_name, timeout<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    identifier <span class="op">=</span> <span class="bu">str</span>(uuid.uuid4())</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    lock_key <span class="op">=</span> <span class="ss">f&quot;lock:</span><span class="sc">{</span>lock_name<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> r.<span class="bu">set</span>(lock_key, identifier, nx<span class="op">=</span><span class="va">True</span>, ex<span class="op">=</span>timeout):</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> identifier</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span></code></pre></div></li>
<li><p><strong>Release Lock</strong>: We must make sure that the lock is
released only by the client who got it.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> release_lock(lock_name, identifier):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    lock_key <span class="op">=</span> <span class="ss">f&quot;lock:</span><span class="sc">{</span>lock_name<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    pipe <span class="op">=</span> r.pipeline()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    pipe.watch(lock_key)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pipe.get(lock_key) <span class="op">==</span> identifier:</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        pipe.multi()</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        pipe.delete(lock_key)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        pipe.execute()</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    pipe.unwatch()</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span></code></pre></div></li>
</ol>
<h3 id="considerations">Considerations:</h3>
<ul>
<li><strong>Lock Timeout</strong>: Set a good timeout to avoid
deadlocks.</li>
<li><strong>Unique Identifier</strong>: Use a special identifier for
each lock. This makes sure that locks are released only by the right
client.</li>
<li><strong>Error Handling</strong>: We should add error handling for
when lock acquisition does not work or releases fail.</li>
</ul>
<p>This distributed locking pattern is very important for tasks like job
processing. Many workers need to work together to use shared resources.
For more information about Redis, we can check <a
href="https://bestonlinetutorial.com/redis/what-is-redis.html">what is
Redis</a>.</p>
<h2 id="how-does-redis-handle-locking-mechanisms">How does Redis handle
locking mechanisms?</h2>
<p>Redis use simple key-value pairs for locking. It uses atomic
operations to make sure locks are created and released safely. The
common way to lock in Redis is with the <code>SETNX</code> command. This
command sets a key only if it does not already exist. It returns 1 if
the key was set and 0 if it was not. This way, we can see if we got the
lock or not.</p>
<h3 id="basic-locking-with-setnx">Basic Locking with SETNX</h3>
<p>Here is a simple example of how we can use Redis for locking:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> acquire_lock(redis_client, lock_key, lock_value, timeout<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try to get the lock</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> redis_client.<span class="bu">set</span>(lock_key, lock_value, ex<span class="op">=</span>timeout, nx<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> release_lock(redis_client, lock_key, lock_value):</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Delete the lock only if it matches the value</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> redis_client.get(lock_key) <span class="op">==</span> lock_value:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        redis_client.delete(lock_key)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>redis_client <span class="op">=</span> redis.StrictRedis(host<span class="op">=</span><span class="st">&#39;localhost&#39;</span>, port<span class="op">=</span><span class="dv">6379</span>, db<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>lock_key <span class="op">=</span> <span class="st">&quot;my_lock&quot;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>lock_value <span class="op">=</span> <span class="st">&quot;unique_lock_value&quot;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> acquire_lock(redis_client, lock_key, lock_value):</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Important section of code</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Lock acquired, executing critical section.&quot;</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">5</span>)  <span class="co"># Simulate some work</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        release_lock(redis_client, lock_key, lock_value)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Lock released.&quot;</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Could not acquire lock.&quot;</span>)</span></code></pre></div>
<h3 id="handling-lock-expiration">Handling Lock Expiration</h3>
<p>Redis can make keys expire automatically. This is good for locks
because it stops deadlocks if the application crashes while holding the
lock. We can set a timeout when we get a lock using the <code>SET</code>
command with <code>EX</code> and <code>NX</code> options.</p>
<h3 id="using-redis-transactions">Using Redis Transactions</h3>
<p>For more tricky locking situations, we can use Redis transactions
with the <code>MULTI</code>, <code>EXEC</code>, and <code>WATCH</code>
commands. This helps us to make sure that many operations run at the
same time.</p>
<h3 id="redis-redlock-algorithm">Redis Redlock Algorithm</h3>
<p>For distributed systems, the Redlock algorithm gives a better way to
lock. It uses many Redis instances to make sure locks are valid across
different nodes. Redlock involves:</p>
<ul>
<li>Getting locks from several Redis instances.</li>
<li>Using timeouts and expiration to make sure locks are released
correctly.</li>
</ul>
<p>This method makes it more reliable and makes sure locks are not held
forever.</p>
<h3 id="summary-of-lock-management">Summary of Lock Management</h3>
<ul>
<li><strong>Atomic Operations</strong>: Use commands like
<code>SETNX</code> for safety.</li>
<li><strong>Expiration</strong>: Keys can expire to stop deadlocks.</li>
<li><strong>Distributed Locking</strong>: Redlock algorithm helps with
locks in distributed systems.</li>
</ul>
<p>By using these methods, we can help Redis manage locks across
different applications and situations. For more info on Redis data
structures and commands, check <a
href="https://bestonlinetutorial.com/redis/what-is-redis.html">what is
Redis</a>.</p>
<h2 id="how-do-we-use-redlock-algorithm-for-distributed-locking">How do
we use Redlock algorithm for distributed locking?</h2>
<p>The Redlock algorithm is a way to manage locks in a distributed
system using Redis. It helps many clients to safely get locks. Here, we
will show the steps and code examples for using the Redlock
algorithm.</p>
<h3 id="implementation-steps">Implementation Steps</h3>
<ol type="1">
<li><p><strong>Create a Unique Lock Identifier</strong>: Each client
needs to make a unique ID for the lock. We usually use UUID for
this.</p></li>
<li><p><strong>Get the Lock</strong>: The client tries to get the lock
by setting a key in Redis with an expiration time.</p></li>
<li><p><strong>Check if Lock is Acquired</strong>: The client checks if
it got the lock. If not, we should try again after a short
wait.</p></li>
<li><p><strong>Release the Lock</strong>: After finishing the critical
section, the client deletes the lock key from Redis. Only the client
that got the lock should release it.</p></li>
</ol>
<h3 id="code-example">Code Example</h3>
<p>Here is a simple example in Python using the <code>redis-py</code>
library:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> uuid</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Redlock:</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, hosts):</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.servers <span class="op">=</span> [redis.StrictRedis(host<span class="op">=</span>host) <span class="cf">for</span> host <span class="kw">in</span> hosts]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> acquire_lock(<span class="va">self</span>, lock_key, ttl):</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        identifier <span class="op">=</span> <span class="bu">str</span>(uuid.uuid4())</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        lock_acquired <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> server <span class="kw">in</span> <span class="va">self</span>.servers:</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> server.<span class="bu">set</span>(lock_key, identifier, nx<span class="op">=</span><span class="va">True</span>, ex<span class="op">=</span>ttl):</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                lock_acquired <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> lock_acquired:</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> identifier</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> release_lock(<span class="va">self</span>, lock_key, identifier):</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> server <span class="kw">in</span> <span class="va">self</span>.servers:</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> server.get(lock_key) <span class="op">==</span> identifier:</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                server.delete(lock_key)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>hosts <span class="op">=</span> [<span class="st">&#39;127.0.0.1:6379&#39;</span>, <span class="st">&#39;127.0.0.1:6380&#39;</span>]</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>dl <span class="op">=</span> Redlock(hosts)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Acquire lock</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>lock_key <span class="op">=</span> <span class="st">&quot;resource_lock&quot;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>ttl <span class="op">=</span> <span class="dv">1000</span>  <span class="co"># Lock expiration time in milliseconds</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>identifier <span class="op">=</span> dl.acquire_lock(lock_key, ttl)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> identifier:</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Lock acquired!&quot;</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Critical section</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Release lock</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    dl.release_lock(lock_key, identifier)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Could not acquire lock.&quot;</span>)</span></code></pre></div>
<h3 id="key-properties">Key Properties</h3>
<ul>
<li><p><strong>Quorum</strong>: The lock is valid when most Redis
instances have it. For example, if we use 5 instances, at least 3 must
hold the lock.</p></li>
<li><p><strong>TTL (Time to Live)</strong>: Each lock needs an
expiration time to avoid deadlocks.</p></li>
<li><p><strong>Retry Logic</strong>: We should use backoff strategies
when we fail to get the lock.</p></li>
</ul>
<h3 id="best-practices">Best Practices</h3>
<ul>
<li>Use unique IDs for each lock we try to get.</li>
<li>Make sure the TTL is shorter than the time we expect to run the
critical section.</li>
<li>Handle errors well for network problems.</li>
<li>Think about using Redis modules that can improve locking.</li>
</ul>
<p>For more information on Redis and what it can do, check out <a
href="https://bestonlinetutorial.com/redis/what-are-redis-data-types.html">this
article on Redis data types</a>.</p>
<h2
id="what-are-practical-code-examples-for-redis-distributed-locking">What
are practical code examples for Redis distributed locking?</h2>
<p>To use distributed locking with Redis, we can choose from many
libraries and methods. Here are some simple code examples in different
programming languages.</p>
<h3 id="python-example">Python Example</h3>
<p>We can use the <code>redis-py</code> library:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> uuid</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Redis client</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>redis_client <span class="op">=</span> redis.StrictRedis(host<span class="op">=</span><span class="st">&#39;localhost&#39;</span>, port<span class="op">=</span><span class="dv">6379</span>, db<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> acquire_lock(lock_name, acquire_time<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    identifier <span class="op">=</span> <span class="bu">str</span>(uuid.uuid4())</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    lock <span class="op">=</span> redis_client.<span class="bu">set</span>(lock_name, identifier, ex<span class="op">=</span>acquire_time, nx<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lock, identifier</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> release_lock(lock_name, identifier):</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    script <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="st">    if redis.call(&quot;get&quot;, KEYS[1]) == ARGV[1] then</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="st">        return redis.call(&quot;del&quot;, KEYS[1])</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="st">        return 0</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="st">    end</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> redis_client.<span class="bu">eval</span>(script, <span class="dv">1</span>, lock_name, identifier)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>lock_name <span class="op">=</span> <span class="st">&quot;my_lock&quot;</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>lock, identifier <span class="op">=</span> acquire_lock(lock_name)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> lock:</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Critical section</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Lock acquired, executing critical section.&quot;</span>)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">5</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        release_lock(lock_name, identifier)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Could not acquire lock.&quot;</span>)</span></code></pre></div>
<h3 id="node.js-example">Node.js Example</h3>
<p>For Node.js, we can use the <code>ioredis</code> library:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Redis <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;ioredis&#39;</span>)<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> redis <span class="op">=</span> <span class="kw">new</span> <span class="fu">Redis</span>()<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">acquireLock</span>(lockName<span class="op">,</span> acquireTime <span class="op">=</span> <span class="dv">10</span>) {</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> identifier <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">set</span>(lockName<span class="op">,</span> identifier<span class="op">,</span> <span class="st">&#39;NX&#39;</span><span class="op">,</span> <span class="st">&#39;EX&#39;</span><span class="op">,</span> acquireTime)<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result <span class="op">?</span> { <span class="dt">lock</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> identifier } <span class="op">:</span> { <span class="dt">lock</span><span class="op">:</span> <span class="kw">false</span> }<span class="op">;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">releaseLock</span>(lockName<span class="op">,</span> identifier) {</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> script <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="vs">    if redis.call(&quot;get&quot;, KEYS[1]) == ARGV[1] then</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="vs">        return redis.call(&quot;del&quot;, KEYS[1])</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="vs">    else</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        return 0</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="vs">    end</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">eval</span>(script<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> lockName<span class="op">,</span> identifier)<span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> lockResponse <span class="op">=</span> <span class="cf">await</span> <span class="fu">acquireLock</span>(<span class="st">&#39;my_lock&#39;</span>)<span class="op">;</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (lockResponse<span class="op">.</span><span class="at">lock</span>) {</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Critical section</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Lock acquired, executing critical section.&quot;</span>)<span class="op">;</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">5000</span>))<span class="op">;</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">finally</span> {</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> <span class="fu">releaseLock</span>(<span class="st">&#39;my_lock&#39;</span><span class="op">,</span> lockResponse<span class="op">.</span><span class="at">identifier</span>)<span class="op">;</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Could not acquire lock.&quot;</span>)<span class="op">;</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>})()<span class="op">;</span></span></code></pre></div>
<h3 id="java-example">Java Example</h3>
<p>In Java, we can use the <code>Jedis</code> library:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">redis</span><span class="op">.</span><span class="im">clients</span><span class="op">.</span><span class="im">jedis</span><span class="op">.</span><span class="im">Jedis</span><span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> RedisLock <span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> Jedis jedis <span class="op">=</span> <span class="kw">new</span> <span class="fu">Jedis</span><span class="op">(</span><span class="st">&quot;localhost&quot;</span><span class="op">);</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">acquireLock</span><span class="op">(</span><span class="bu">String</span> lockName<span class="op">,</span> <span class="dt">int</span> acquireTime<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> identifier <span class="op">=</span> <span class="bu">String</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">());</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> result <span class="op">=</span> jedis<span class="op">.</span><span class="fu">set</span><span class="op">(</span>lockName<span class="op">,</span> identifier<span class="op">,</span> <span class="st">&quot;NX&quot;</span><span class="op">,</span> <span class="st">&quot;EX&quot;</span><span class="op">,</span> acquireTime<span class="op">);</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result <span class="op">!=</span> <span class="kw">null</span> <span class="op">?</span> identifier <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">releaseLock</span><span class="op">(</span><span class="bu">String</span> lockName<span class="op">,</span> <span class="bu">String</span> identifier<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> script <span class="op">=</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then &quot;</span> <span class="op">+</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;return redis.call(&#39;del&#39;, KEYS[1]) &quot;</span> <span class="op">+</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;else return 0 end&quot;</span><span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> jedis<span class="op">.</span><span class="fu">eval</span><span class="op">(</span>script<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> lockName<span class="op">,</span> identifier<span class="op">).</span><span class="fu">equals</span><span class="op">(</span><span class="dv">1L</span><span class="op">);</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        RedisLock redisLock <span class="op">=</span> <span class="kw">new</span> <span class="fu">RedisLock</span><span class="op">();</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> lockName <span class="op">=</span> <span class="st">&quot;my_lock&quot;</span><span class="op">;</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> identifier <span class="op">=</span> redisLock<span class="op">.</span><span class="fu">acquireLock</span><span class="op">(</span>lockName<span class="op">,</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>identifier <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Critical section</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Lock acquired, executing critical section.&quot;</span><span class="op">);</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">5000</span><span class="op">);</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>                e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>                redisLock<span class="op">.</span><span class="fu">releaseLock</span><span class="op">(</span>lockName<span class="op">,</span> identifier<span class="op">);</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Could not acquire lock.&quot;</span><span class="op">);</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>These examples show how we can use Redis for distributed locking in
different programming languages. For more details about using Redis, we
can check out <a
href="https://bestonlinetutorial.com/redis/how-do-i-use-redis-with-python.html">How
do I use Redis with Python</a>, <a
href="https://bestonlinetutorial.com/redis/how-do-i-use-redis-with-node-js.html">How
do I use Redis with Node.js</a>, and <a
href="https://bestonlinetutorial.com/redis/how-do-i-use-redis-with-java.html">How
do I use Redis with Java</a>.</p>
<h2 id="how-to-handle-lock-expiration-and-renewal-in-redis">How to
handle lock expiration and renewal in Redis?</h2>
<p>Handling lock expiration and renewal in Redis is important. It helps
to make sure that locks do not stay forever if there are failures or
timeouts. We can use some strategies with Redis commands and patterns to
manage this well.</p>
<h3 id="lock-expiration">Lock Expiration</h3>
<p>When we create a lock in Redis, we need to set a timeout. This helps
to avoid deadlocks. We can do this with the <code>SET</code> command. We
will use the <code>NX</code> option (which means set if not exists) and
also set a timeout.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">SET</span> lock_key <span class="st">&quot;lock_value&quot;</span> NX EX 30</span></code></pre></div>
<p>In this example, the lock will expire after 30 seconds if we do not
release it.</p>
<h3 id="lock-renewal">Lock Renewal</h3>
<p>If we want to renew a lock before it expires, we need to reset the
timeout. We can do this with the <code>EXPIRE</code> command:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">EXPIRE</span> lock_key 30</span></code></pre></div>
<p>This command will reset the timeout to 30 seconds. This way, the
process that holds the lock can keep it as long as needed.</p>
<h3 id="handling-lock-expiration-in-application-code">Handling Lock
Expiration in Application Code</h3>
<ol type="1">
<li><strong>Acquire Lock</strong>: We try to get the lock with a
timeout.</li>
<li><strong>Perform Task</strong>: We run the important part of the
code.</li>
<li><strong>Renew Lock</strong>: We renew the lock often if the task
takes a long time.</li>
<li><strong>Release Lock</strong>: We remove the lock when the task is
done.</li>
</ol>
<h3 id="example-code-snippet-python-with-redis">Example Code Snippet
(Python with Redis)</h3>
<p>Here is a simple example in Python using the <code>redis-py</code>
library:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> redis.StrictRedis(host<span class="op">=</span><span class="st">&#39;localhost&#39;</span>, port<span class="op">=</span><span class="dv">6379</span>, db<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>lock_key <span class="op">=</span> <span class="st">&quot;my_lock&quot;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>lock_value <span class="op">=</span> <span class="st">&quot;unique_value&quot;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Acquire lock with expiration</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> acquire_lock():</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> client.<span class="bu">set</span>(lock_key, lock_value, nx<span class="op">=</span><span class="va">True</span>, ex<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Renew lock</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> renew_lock():</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    client.expire(lock_key, <span class="dv">30</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Release lock</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> release_lock():</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    client.delete(lock_key)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the lock</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> acquire_lock():</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Critical section</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Perform some operations</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>            time.sleep(<span class="dv">10</span>)  <span class="co"># Simulate long operation</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>            renew_lock()  <span class="co"># Renew the lock often</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        release_lock()  <span class="co"># Always remove the lock</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Could not acquire lock.&quot;</span>)</span></code></pre></div>
<h3 id="considerations-1">Considerations</h3>
<ul>
<li><strong>Lock Ownership</strong>: We need to make sure that only the
process that got the lock can renew it. Use unique IDs to keep track of
who owns it.</li>
<li><strong>Graceful Handling</strong>: We should handle cases where the
lock might expire while the task is still going. We need to have error
handling for these situations.</li>
<li><strong>Avoiding Race Conditions</strong>: We should use atomic
actions to check and set locks to stop race conditions from
happening.</li>
</ul>
<p>This way, we can handle lock expiration and renewal in Redis well. It
gives us a strong distributed locking system for our applications. For
more information about Redis and how it works, we can check other
resources like <a
href="https://bestonlinetutorial.com/redis/how-do-i-install-redis.html">how
to install Redis</a>.</p>
<h2
id="what-are-the-best-practices-for-using-redis-for-distributed-locking">What
are the best practices for using Redis for distributed locking?</h2>
<p>To use Redis for distributed locking well, we should think about
these best practices:</p>
<ol type="1">
<li><p><strong>Use Unique Lock Identifiers</strong>: We need to create a
unique ID for each lock. This can be a UUID or a special string like a
session ID. It helps us see which locks different clients hold.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> uuid</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>lock_id <span class="op">=</span> <span class="bu">str</span>(uuid.uuid4())</span></code></pre></div></li>
<li><p><strong>Set an Expiration Time</strong>: Always set a time limit
on locks to stop deadlocks. Pick a timeout that makes sense for how long
the job should take.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> redis.Redis()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>lock_key <span class="op">=</span> <span class="st">&quot;my_lock&quot;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>lock_timeout <span class="op">=</span> <span class="dv">5</span>  <span class="co"># seconds</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>r.<span class="bu">set</span>(lock_key, lock_id, ex<span class="op">=</span>lock_timeout, nx<span class="op">=</span><span class="va">True</span>)</span></code></pre></div></li>
<li><p><strong>Implement Retry Logic</strong>: When we try to get a
lock, we should have a way to try again using exponential backoff. This
helps to deal with busy locks better.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> acquire_lock_with_retry(lock_key, lock_id, retries<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retries):</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> r.<span class="bu">set</span>(lock_key, lock_id, ex<span class="op">=</span>lock_timeout, nx<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">2</span> <span class="op">**</span> attempt)  <span class="co"># Exponential backoff</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span></code></pre></div></li>
<li><p><strong>Handle Lock Expiration and Renewal</strong>: If getting a
lock takes too long, we should renew it before it runs out. This stops
it from being released too soon.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> renew_lock(lock_key, lock_id):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> r.get(lock_key) <span class="op">==</span> lock_id:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        r.expire(lock_key, lock_timeout)</span></code></pre></div></li>
<li><p><strong>Use Lua Scripting</strong>: For safe operations, we
should use Lua scripts. They make sure that check-and-set actions happen
in one step.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Lua script for acquiring a lock</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">current</span> <span class="op">=</span> <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;get&#39;</span><span class="op">,</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="va">current</span> <span class="cf">then</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">redis</span><span class="op">.</span>call<span class="op">(</span><span class="st">&#39;set&#39;</span><span class="op">,</span> <span class="cn">KEYS</span><span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="cn">ARGV</span><span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="st">&#39;EX&#39;</span><span class="op">,</span> <span class="cn">ARGV</span><span class="op">[</span><span class="dv">2</span><span class="op">])</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div></li>
<li><p><strong>Monitor Lock Status</strong>: We should keep track of
when locks are taken and released. This helps us find problems in our
app.</p></li>
<li><p><strong>Avoid Long Lock Times</strong>: We want to keep how long
we hold a lock short. If a job takes too long, we can break it into
smaller parts or try a different locking plan.</p></li>
<li><p><strong>Clean Up Stale Locks</strong>: We need a way to remove
locks that are not released because of crashes or other issues.</p></li>
<li><p><strong>Limit Lock Scope</strong>: We should only lock parts of
code that need synchronization. This reduces competition and makes
things faster.</p></li>
<li><p><strong>Test in Production-like Environments</strong>: Before we
go live, we need to test our locking system under load. This makes sure
it works as we expect.</p></li>
</ol>
<p>By following these best practices, we can use Redis for distributed
locking well. This helps our application keep data safe and consistent
across different systems. For more details on using Redis smartly, visit
<a
href="https://bestonlinetutorial.com/redis/what-are-the-best-practices-for-redis-optimization.html">Redis
Best Practices</a>.</p>
<h2 id="frequently-asked-questions">Frequently Asked Questions</h2>
<h3 id="what-is-the-purpose-of-distributed-locking-in-redis">1. What is
the purpose of distributed locking in Redis?</h3>
<p>We use distributed locking in Redis to manage many processes in
distributed systems. It makes sure that only one process can use a
resource at one time. This helps stop race conditions and data problems.
By using Redis for locking, we can easily synchronize access across
different instances. This keeps our data safe and consistent.</p>
<h3 id="how-does-redis-implement-distributed-locking">2. How does Redis
implement distributed locking?</h3>
<p>Redis uses simple key-value pairs to implement distributed locking. A
process sets a key with a unique ID and a time limit. If the key is
already there, the process cannot get the lock. This way is simple but
works well. For more complex needs, the <strong>Redlock
algorithm</strong> gives a stronger solution. It makes sure locks are
valid across many Redis instances.</p>
<h3 id="what-is-the-redlock-algorithm-in-redis">3. What is the Redlock
algorithm in Redis?</h3>
<p>The Redlock algorithm helps us achieve distributed locking when we
have many Redis instances. It means we must get locks from most Redis
nodes to keep things safe. If a process gets locks from at least half of
the nodes, it can go ahead safely. This method helps with problems like
network issues and node failures. So, it is good for distributed
systems.</p>
<h3 id="how-should-i-handle-lock-expiration-in-redis">4. How should I
handle lock expiration in Redis?</h3>
<p>We need to handle lock expiration in Redis to avoid problems. When we
get a lock, we should set a time limit for it to be released. If the
process needs more time, we should renew the lock before it runs out.
Having a renewal plan helps us keep access and avoid failures in locking
situations. This protects us from unexpected process stops.</p>
<h3
id="what-are-the-best-practices-for-using-redis-for-distributed-locking-1">5.
What are the best practices for using Redis for distributed
locking?</h3>
<p>When we use Redis for distributed locking, we should follow some best
practices. First, use a unique ID for each lock. Next, set good
expiration times. Also, we need to handle errors when we try to get a
lock. We can use the Redlock algorithm for better reliability in
distributed systems. Always clean up old locks and keep an eye on our
locking process. This helps us keep things running smoothly and avoid
slowdowns.</p>
<p>For more information on Redis features, you can check <a
href="https://bestonlinetutorial.com/redis/what-is-redis.html">what is
Redis</a> or learn about <a
href="https://bestonlinetutorial.com/redis/how-do-i-install-redis.html">how
to install Redis</a> to improve your knowledge of this powerful
database.</p>

                        </div>

                    </div>
                    <!--//container-->
                </article>

            </div>
            <!--//main-wrapper-->

            <div id="footer-placeholder"></div>

            <!-- Javascript -->
            <script src="/assets/plugins/popper.min.js" defer></script>
            <script src="/assets/plugins/bootstrap/js/bootstrap.min.js" defer></script>
            <script src="/assets/fontawesome/js/all.min.js" defer></script>
        </body>

        </html>
            
            